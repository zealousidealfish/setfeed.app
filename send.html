<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Send — Setfeed</title>
  <meta name="description" content="Send an end-to-end encrypted message to Setfeed." />
  <meta name="theme-color" content="#0F1114" id="meta-theme-color" />

  <link rel="icon" href="./favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="./favicon-32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="./favicon-16.png" sizes="16x16">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png" sizes="180x180">

  <link rel="stylesheet" href="./styles.css" />

  <!-- =========================
       FIREBASE (AUTH + FUNCTIONS + APP CHECK)
       ========================= -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCECKG-00tijJrt5qvRy3L27ZzE7bocNrU",
      authDomain: "setfeed-fcd7a.firebaseapp.com",
      projectId: "setfeed-fcd7a",
      storageBucket: "setfeed-fcd7a.firebasestorage.app",
      messagingSenderId: "553573263069",
      appId: "1:553573263069:web:e5c9884101ca38eaee1d34"
    };

    // TODO: replace with your real App Check reCAPTCHA v3 site key
    const RECAPTCHA_SITE_KEY = "6LfgvG0sAAAAANQjlRbdsWx6GMQw1kP2kuOPjeJI";

    // Your public site URL (GitHub Pages custom domain)
    const SITE_ORIGIN = "https://setfeed.app";

    if (!firebase.apps || firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);

    const functions = firebase.app().functions("europe-west2");

    function startAppCheck() {
      try {
        firebase.appCheck().activate(RECAPTCHA_SITE_KEY, true);
        console.log("[AppCheck] activated");
      } catch (e) {
        console.warn("[AppCheck] init failed:", e);
      }
    }
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", startAppCheck, { once: true });
    } else {
      startAppCheck();
    }
  </script>

  <!-- =========================
       THEME (deterministic)
       ========================= -->
  <script>
    (function(){
      const THEME_KEY = "sf_theme_mode";
      const root = document.documentElement;

      function applyTheme(){
        let stored = "system";
        try { stored = localStorage.getItem(THEME_KEY) || "system"; } catch (_) {}

        if (stored === "light" || stored === "dark") root.setAttribute("data-theme", stored);
        else root.removeAttribute("data-theme");

        const effective =
          root.getAttribute("data-theme") ||
          (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");

        const meta = document.getElementById("meta-theme-color");
        if (meta) meta.content = (effective === "dark") ? "#0F1114" : "#FFFBFE";
      }

      applyTheme();
      window.addEventListener("storage", (e) => { if (e && e.key === THEME_KEY) applyTheme(); });
    })();
  </script>

  <style>
    .hidden{ display:none !important; }

    /* status placement slots */
    .sf-status-slot{ margin-top: 10px; }

    /* Keep your existing styles.css look; no colors hardcoded here */
  </style>
</head>

<body class="page-bg">
  <header class="site-header">
    <div class="header-inner">
      <a class="brand-mark" href="./" aria-label="Setfeed home">
        <img class="logo" src="./logo.png" alt="" aria-hidden="true" />
      </a>

      <a class="brand-title" href="./">Setfeed</a>

      <nav class="nav" aria-label="Primary">
        <a href="./">Home</a>
        <a href="./send.html" aria-current="page">Send</a>
        <a href="./receive.html">Receive</a>
        <a class="auth-only hidden" href="./inbox.html">Inbox</a>
        <a href="./security.html">Security</a>
        <a href="./privacy.html">Privacy</a>
        <a class="nav-cta" href="#" aria-label="Download Setfeed app">Download app</a>
      </nav>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <h1>Send a scheduled message</h1>
      <p class="lead">
        Messages are encrypted in your browser before they reach Setfeed servers.
        The server stores ciphertext only.
      </p>

      <div class="pills" aria-label="Send highlights">
        <div class="pill"><span class="dot good"></span> End-to-end encrypted</div>
        <div class="pill"><span class="dot good"></span> Ciphertext-only storage</div>
        <div class="pill"><span class="dot warn"></span> Rolling is constrained</div>
      </div>

      <h2>Choose a send type</h2>
      <div class="tabs" role="tablist" aria-label="Send type">
        <button class="tab" id="tab-signed" role="tab" aria-selected="true" aria-controls="panel-signed" type="button">
          Signed (Secure / Personal)
        </button>
        <button class="tab" id="tab-rolling" role="tab" aria-selected="false" aria-controls="panel-rolling" type="button">
          Rolling (no sign-in)
        </button>
      </div>

      <!-- Signed panel -->
      <div id="panel-signed" role="tabpanel" aria-labelledby="tab-signed">
        <div class="row">
          <div class="col" id="signin">
            <div class="field">
              <label for="signed-email">Email</label>
              <input id="signed-email" type="email" autocomplete="email" placeholder="you@example.com" />
            </div>

            <div class="actions">
              <button class="btn btn-lg" id="btn-send-link" type="button">Send sign-in link</button>

              <button class="btn btn-lg btn-primary" id="btn-google" type="button" aria-label="Continue with Google">
                <span>Google</span>
              </button>

              <button class="btn btn-lg btn-quiet hidden" id="btn-sign-out" type="button" disabled>Sign out</button>
            </div>

            <div class="sf-auth-banner hidden" id="sf-auth-banner">
              <span id="sf-auth-label">Signed in</span>
              <button class="btn btn-secondary" id="btn-go-inbox" type="button">Go to Inbox</button>
            </div>

            <div class="note">
              <p style="margin:0;">
                Signed send requires sign-in (Email link or Google). It is required for Secure and Personal codes.
              </p>
            </div>

            <!-- Top slot for Status when signed in (replaces video area) -->
            <div id="status-slot-top" class="sf-status-slot hidden"></div>

            <div class="video-card" id="video-signed" aria-label="Walkthrough">
              <h2 style="margin-top:0;">Walkthrough</h2>
              <p class="lead" style="margin-bottom: 0;">
                A short demonstration of the web send flow. No autoplay. Controls only.
              </p>

              <div class="video-frame">
                <video controls preload="metadata" playsinline poster="./poster.png">
                  <source src="./walkthrough.mp4" type="video/mp4" />
                  Sorry — your browser can’t play this video.
                </video>
              </div>

              <small class="help">
                Demonstration supports clarity. UI stays calm and predictable.
              </small>
            </div>
          </div>

          <div class="col">
            <div class="field">
              <label for="signed-code">Secure or Personal code</label>
              <input id="signed-code" type="text" inputmode="text" placeholder="Paste a Secure (SFS-…) or Personal (SF-…) code" />
            </div>

            <div class="field">
              <label for="signed-body">Message</label>
              <textarea id="signed-body" maxlength="1200" placeholder="Write your message…"></textarea>
            </div>

            <div class="actions">
              <button class="btn btn-lg btn-primary" id="btn-signed-send" type="button" disabled>Encrypt &amp; send</button>
              <button class="btn btn-lg btn-quiet" id="btn-signed-clear" type="button">Clear</button>
            </div>

            <small class="help">
              Only the recipient device can decrypt. If a code is invalid, you’ll be told explicitly.
            </small>

            <h2>Delivery</h2>
            <div class="panel">
              <p class="panel-sub" id="signed-delivery-sub" style="margin-bottom: var(--s-3);">
                Signed sends can schedule sooner (e.g., Delvex 2–3 minutes, 10 minutes / 1 hour) or use tomorrow presets.
              </p>

              <!-- Preset time chips (tomorrow) -->
              <div class="chips" aria-label="Tomorrow preset times (signed)" id="signed-preset-chips">
                <button class="chip" type="button" aria-pressed="false" data-time="08:00">8am</button>
                <button class="chip" type="button" aria-pressed="true"  data-time="13:00">1pm</button>
                <button class="chip" type="button" aria-pressed="false" data-time="18:00">6pm</button>
              </div>

              <!-- Advanced options (only when signed in) -->
              <div class="sf-adv-row hidden" id="signed-advanced-row">
                <button class="sf-adv-btn" type="button" aria-pressed="true" data-mode="preset">Tomorrow preset</button>
                <button class="sf-adv-btn" type="button" aria-pressed="false" data-mode="2m">Delvex (2 min)</button>
                <button class="sf-adv-btn" type="button" aria-pressed="false" data-mode="3m">Delvex (3 min)</button>
                <button class="sf-adv-btn" type="button" aria-pressed="false" data-mode="10m">In 10 minutes</button>
                <button class="sf-adv-btn" type="button" aria-pressed="false" data-mode="1h">In 1 hour</button>
              </div>

              <small class="help" id="signed-delivery-help" style="margin-top: 10px;">
                Delvex is a short-delay surprise drop. Recipient should keep Inbox open for precise timing.
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Rolling panel -->
      <div id="panel-rolling" role="tabpanel" aria-labelledby="tab-rolling" class="hidden">
        <div class="row">
          <div class="col">
            <div class="field">
              <label for="rolling-code">Rolling code</label>
              <input id="rolling-code" type="text" inputmode="text" placeholder="Paste a Rolling code (SFR-…)" />
            </div>

            <div class="video-card" id="video-rolling" aria-label="Walkthrough">
              <h2 style="margin-top:0;">Walkthrough</h2>
              <p class="lead" style="margin-bottom: 0;">
                A short demonstration of the rolling send flow. No autoplay. Controls only.
              </p>

              <div class="video-frame">
                <video controls preload="metadata" playsinline poster="./poster.png">
                  <source src="./walkthrough.mp4" type="video/mp4" />
                  Sorry — your browser can’t play this video.
                </video>
              </div>

              <small class="help">
                Rolling is constrained. Expect explicit errors if expired or over limits.
              </small>
            </div>
          </div>

          <div class="col">
            <div class="field">
              <label for="rolling-body">Message</label>
              <textarea id="rolling-body" maxlength="1200" placeholder="Write your message…"></textarea>
            </div>

            <div class="actions">
              <button class="btn btn-lg btn-primary" id="btn-rolling-send" type="button" disabled>Encrypt &amp; send</button>
              <button class="btn btn-lg btn-quiet" id="btn-rolling-clear" type="button">Clear</button>
            </div>

            <small class="help">
              Rolling is meant for temporary sharing. It may expire or become invalid after use.
            </small>

            <h2>Delivery (rolling)</h2>
            <div class="panel">
              <p class="panel-sub" style="margin-bottom: var(--s-3);">
                Rolling is always constrained to tomorrow at 08:00, 13:00, or 18:00 (your local time).
              </p>
              <div class="chips" aria-label="Tomorrow preset times (rolling)" id="rolling-chips">
                <button class="chip" type="button" aria-pressed="false" data-time="08:00">8am</button>
                <button class="chip" type="button" aria-pressed="true"  data-time="13:00">1pm</button>
                <button class="chip" type="button" aria-pressed="false" data-time="18:00">6pm</button>
              </div>
            </div>

            <h2 style="margin-top: var(--s-6);">What to expect</h2>
            <ul>
              <li>No sign-in required.</li>
              <li>Strict guardrails (validity, usage limits, rate limiting).</li>
              <li>Clear errors when something can’t be sent.</li>
            </ul>

            <div class="note">
              <p style="margin:0;">
                If you want a stable link, use Secure (signed) for yourself.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Status container (this box moves between slots) -->
      <div id="status-slot-bottom">
        <h2>Status</h2>
        <div class="status" id="status-box" role="status" aria-live="polite">
          <div class="status-title">
            <span class="dot" id="status-dot"></span>
            <span id="status-title">Not connected</span>
          </div>
          <p class="status-line" id="status-line">Ready.</p>
        </div>
      </div>

      <footer>
        <div>© <span id="y"></span> Setfeed</div>
        <div>
          <a href="./security.html">Security</a>
          <span class="sep">·</span>
          <a href="./privacy.html">Privacy</a>
          <span class="sep">·</span>
          <a href="mailto:security@setfeed.app">security@setfeed.app</a>
        </div>
      </footer>
    </div>
  </div>

  <script>
    document.getElementById("y").textContent = new Date().getFullYear();

    // -------------------------
    // Tabs
    // -------------------------
    const tabSigned = document.getElementById("tab-signed");
    const tabRolling = document.getElementById("tab-rolling");
    const panelSigned = document.getElementById("panel-signed");
    const panelRolling = document.getElementById("panel-rolling");

    function setTab(which) {
      const signed = which === "signed";
      tabSigned.setAttribute("aria-selected", signed ? "true" : "false");
      tabRolling.setAttribute("aria-selected", signed ? "false" : "true");
      panelSigned.classList.toggle("hidden", !signed);
      panelRolling.classList.toggle("hidden", signed);
    }
    tabSigned.addEventListener("click", () => setTab("signed"));
    tabRolling.addEventListener("click", () => setTab("rolling"));

    // -------------------------
    // Status helper
    // -------------------------
    const statusDot = document.getElementById("status-dot");
    const statusTitle = document.getElementById("status-title");
    const statusLine = document.getElementById("status-line");

    function setStatus(kind, title, line) {
      statusDot.className = "dot";
      if (kind === "good") statusDot.classList.add("good");
      if (kind === "warn") statusDot.classList.add("warn");
      statusTitle.textContent = title;
      statusLine.textContent = line;
    }

    // -------------------------
    // Elements
    // -------------------------
    const signedEmail = document.getElementById("signed-email");
    const signedCode = document.getElementById("signed-code");
    const signedBody = document.getElementById("signed-body");
    const btnSendLink = document.getElementById("btn-send-link");
    const btnGoogle = document.getElementById("btn-google");
    const btnSignOut = document.getElementById("btn-sign-out");
    const btnGoInbox = document.getElementById("btn-go-inbox");
    const btnSignedSend = document.getElementById("btn-signed-send");
    const btnSignedClear = document.getElementById("btn-signed-clear");
    const videoSigned = document.getElementById("video-signed");
    const signedDeliverySub = document.getElementById("signed-delivery-sub");
    const signedDeliveryHelp = document.getElementById("signed-delivery-help");
    const signedAdvancedRow = document.getElementById("signed-advanced-row");
    const authBanner = document.getElementById("sf-auth-banner");
    const authLabel = document.getElementById("sf-auth-label");

    const rollingCodeInput = document.getElementById("rolling-code");
    const rollingBodyInput = document.getElementById("rolling-body");
    const btnRollingSend = document.getElementById("btn-rolling-send");
    const btnRollingClear = document.getElementById("btn-rolling-clear");
    const videoRolling = document.getElementById("video-rolling");

    // Status movement slots
    const statusBox = document.getElementById("status-box");
    const statusSlotTop = document.getElementById("status-slot-top");
    const statusSlotBottom = document.getElementById("status-slot-bottom");

    // -------------------------
    // Auth (real)
    // -------------------------
    const AUTH_KEY = "sf_signed_authed";
    const EMAIL_FOR_SIGNIN_KEY = "sf_email_for_signin";
    const auth = firebase.auth();

    function setSignedAuthedFlag(isAuthed) {
      try { localStorage.setItem(AUTH_KEY, isAuthed ? "true" : "false"); } catch (_) {}
      document.querySelectorAll(".auth-only").forEach(el => el.classList.toggle("hidden", !isAuthed));
    }

    function refreshSignedSendEnabled(isAuthed) {
      const canSend = isAuthed
        && signedCode.value.trim().length > 0
        && signedBody.value.trim().length > 0;
      btnSignedSend.disabled = !canSend;
    }

    function refreshRollingSendEnabled() {
      const canSend = rollingCodeInput.value.trim().length > 0
        && rollingBodyInput.value.trim().length > 0;
      btnRollingSend.disabled = !canSend;
    }

    function moveStatusToTop(isAuthed) {
      if (!statusBox || !statusSlotTop || !statusSlotBottom) return;

      if (isAuthed) {
        statusSlotTop.classList.remove("hidden");
        statusSlotBottom.classList.add("hidden");
        statusSlotTop.appendChild(statusBox);
      } else {
        statusSlotTop.classList.add("hidden");
        statusSlotBottom.classList.remove("hidden");
        // statusBox is inside statusSlotBottom already, but we re-append to be safe
        statusSlotBottom.querySelector(".status-title") || statusSlotBottom.appendChild(statusBox);
      }
    }

    function renderAuthUI(user) {
      const isAuthed = !!user;

      // hide email + send link when authed
      const emailField = signedEmail ? signedEmail.closest(".field") : null;
      if (emailField) emailField.classList.toggle("hidden", isAuthed);
      if (btnSendLink) btnSendLink.classList.toggle("hidden", isAuthed);

      // hide google when authed
      if (btnGoogle) btnGoogle.classList.toggle("hidden", isAuthed);

      // sign out only visible when authed
      if (btnSignOut) {
        btnSignOut.disabled = !isAuthed;
        btnSignOut.classList.toggle("hidden", !isAuthed);
      }

      setSignedAuthedFlag(isAuthed);

      // when authed, hide walkthrough (both tabs)
      if (videoSigned) videoSigned.classList.toggle("hidden", isAuthed);
      if (videoRolling) videoRolling.classList.toggle("hidden", isAuthed);

      // advanced scheduling visible only when authed
      if (signedAdvancedRow) signedAdvancedRow.classList.toggle("hidden", !isAuthed);

      // show banner with email
      if (authBanner && authLabel) {
        authBanner.classList.toggle("hidden", !isAuthed);
        if (isAuthed) authLabel.textContent = user.email || "Signed in";
      }

      // move status box into the former video position when authed
      moveStatusToTop(isAuthed);

      if (signedDeliverySub && signedDeliveryHelp) {
        if (isAuthed) {
          signedDeliverySub.textContent = "Signed in: Delvex (2–3 min), 10 minutes / 1 hour, or tomorrow presets.";
          signedDeliveryHelp.textContent = "Delvex is a short-delay surprise drop. Recipient should keep Inbox open for precise timing.";
        } else {
          signedDeliverySub.textContent = "Sign in (Email link or Google) to send Signed (Secure / Personal).";
          signedDeliveryHelp.textContent = "Rolling is always available without signing in.";
        }
      }

      refreshSignedSendEnabled(isAuthed);
    }

    auth.onAuthStateChanged((user) => renderAuthUI(user));

    // Google popup
    btnGoogle.addEventListener("click", async () => {
      try {
        setStatus("good", "Signing in…", "Opening Google sign-in…");
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: "select_account" });
        await auth.signInWithPopup(provider);
        setStatus("good", "Signed in", "You can send Signed messages now.");
      } catch (e) {
        console.error(e);
        setStatus("warn", "Couldn’t sign in", "Google sign-in failed. Check pop-up blocking and try again.");
      }
    });

    // Email link (passwordless)
    btnSendLink.addEventListener("click", async () => {
      const email = signedEmail.value.trim();
      if (!email) {
        setStatus("warn", "Email needed", "Enter your email to request a sign-in link.");
        return;
      }

      try {
        setStatus("good", "Sending link…", "Check your inbox for the sign-in link.");
        const actionCodeSettings = {
          url: `${SITE_ORIGIN}/send.html#finishSignIn`,
          handleCodeInApp: true
        };

        await auth.sendSignInLinkToEmail(email, actionCodeSettings);
        try { localStorage.setItem(EMAIL_FOR_SIGNIN_KEY, email); } catch (_) {}
        setStatus("good", "Link sent", "Open the link from your email on this device to finish signing in.");
      } catch (e) {
        console.error(e);
        setStatus("warn", "Couldn’t send link", "Email-link sign-in failed. Verify Auth is enabled and your domain is authorized.");
      }
    });

    // Complete email-link sign-in if present
    (async function finishEmailLinkIfPresent(){
      try {
        const href = window.location.href;
        if (!auth.isSignInWithEmailLink(href)) return;

        let email = "";
        try { email = localStorage.getItem(EMAIL_FOR_SIGNIN_KEY) || ""; } catch (_) {}
        if (!email) {
          email = window.prompt("Confirm your email to finish sign-in:");
          if (!email) {
            setStatus("warn", "Sign-in not finished", "Email is required to finish sign-in.");
            return;
          }
        }

        setStatus("good", "Signing in…", "Finishing email-link sign-in…");
        await auth.signInWithEmailLink(email, href);

        try { localStorage.removeItem(EMAIL_FOR_SIGNIN_KEY); } catch (_) {}
        setStatus("good", "Signed in", "You can send Signed messages now.");
        history.replaceState(null, "", "./send.html#signin");
      } catch (e) {
        console.error(e);
        setStatus("warn", "Sign-in failed", "Couldn’t finish email-link sign-in. Try sending a new link.");
      }
    })();

    btnSignOut.addEventListener("click", async () => {
      try {
        await auth.signOut();
        setStatus("warn", "Signed out", "Signed sending is unavailable until you sign in again.");
      } catch (e) {
        console.error(e);
        setStatus("warn", "Couldn’t sign out", "Try again.");
      }
    });

    btnGoInbox.addEventListener("click", () => {
      window.location.href = "./inbox.html";
    });

    // -------------------------
    // Scheduling UI state
    // -------------------------
    let signedPresetTime = "13:00";
    let signedMode = "preset"; // "preset" | "2m" | "3m" | "10m" | "1h"

    const signedPresetChips = Array.from(document.querySelectorAll('#signed-preset-chips .chip[data-time]'));
    const signedAdvBtns = Array.from(document.querySelectorAll('#signed-advanced-row .sf-adv-btn[data-mode]'));

    function setSignedPresetHighlightVisible(visible) {
      if (!visible) {
        signedPresetChips.forEach(b => b.setAttribute("aria-pressed", "false"));
        return;
      }
      // restore highlight to current signedPresetTime
      signedPresetChips.forEach(b => {
        const t = b.getAttribute("data-time") || "";
        b.setAttribute("aria-pressed", (t === signedPresetTime) ? "true" : "false");
      });
    }

    function setSignedMode(nextMode) {
      signedMode = nextMode || "preset";

      // highlight the chosen advanced button
      signedAdvBtns.forEach(b => b.setAttribute("aria-pressed", "false"));
      const btn = signedAdvBtns.find(b => (b.getAttribute("data-mode") || "") === signedMode);
      if (btn) btn.setAttribute("aria-pressed", "true");

      // If not preset, remove highlight from preset chips to avoid confusion
      if (signedMode !== "preset") setSignedPresetHighlightVisible(false);
      else setSignedPresetHighlightVisible(true);
    }

    // Clicking a preset chip should imply preset mode
    signedPresetChips.forEach(btn => {
      btn.addEventListener("click", () => {
        signedPresetTime = btn.getAttribute("data-time") || "13:00";
        setSignedMode("preset");
      });
    });

    signedAdvBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        const mode = btn.getAttribute("data-mode") || "preset";
        setSignedMode(mode);
      });
    });

    let rollingPresetTime = "13:00";
    document.querySelectorAll('#rolling-chips .chip[data-time]').forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll('#rolling-chips .chip[data-time]').forEach(b => b.setAttribute("aria-pressed", "false"));
        btn.setAttribute("aria-pressed", "true");
        rollingPresetTime = btn.getAttribute("data-time") || "13:00";
      });
    });

    // -------------------------
    // Crypto helpers (WebCrypto)
    // -------------------------
    function normalizeCodeAndroid(raw) {
      return raw.trim().toUpperCase().replace(/[\s-]/g, "");
    }

    function bytesToB64(bytes) {
      let binary = "";
      const chunk = 0x8000;
      for (let i = 0; i < bytes.length; i += chunk) {
        binary += String.fromCharCode(...bytes.subarray(i, i + chunk));
      }
      return btoa(binary);
    }

    function abToB64(ab) { return bytesToB64(new Uint8Array(ab)); }

    async function sha256Hex(str) {
      const data = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest("SHA-256", data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function deriveAesKeyFromPassphrase(passphrase, saltBytes) {
      const passBytes = new TextEncoder().encode(passphrase);
      const baseKey = await crypto.subtle.importKey("raw", passBytes, { name: "PBKDF2" }, false, ["deriveKey"]);
      return await crypto.subtle.deriveKey(
        { name: "PBKDF2", salt: saltBytes, iterations: 100000, hash: "SHA-256" },
        baseKey,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }

    async function encryptBodyForCode(rawCode, plaintext) {
      const passphrase = normalizeCodeAndroid(rawCode);
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));

      const key = await deriveAesKeyFromPassphrase(passphrase, salt);
      const ptBytes = new TextEncoder().encode(plaintext);
      const ct = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, ptBytes);

      return {
        ciphertextB64: abToB64(ct),
        ivB64: bytesToB64(iv),
        saltB64: bytesToB64(salt),
        normalizedPassphrase: passphrase
      };
    }

    function getUserTimezone() {
      return Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
    }

    function pad2(n) { return String(n).padStart(2, "0"); }

    function toLocalIsoWithOffset(date) {
      const d = new Date(date.getTime());
      d.setSeconds(0, 0);

      const offMin = -d.getTimezoneOffset();
      const sign = offMin >= 0 ? "+" : "-";
      const abs = Math.abs(offMin);
      const offH = pad2(Math.floor(abs / 60));
      const offM = pad2(abs % 60);

      const yyyy = d.getFullYear();
      const mon = pad2(d.getMonth() + 1);
      const day = pad2(d.getDate());
      const hour = pad2(d.getHours());
      const minute = pad2(d.getMinutes());

      return `${yyyy}-${mon}-${day}T${hour}:${minute}:00${sign}${offH}:${offM}`;
    }

    function deliverAtLocalIsoTomorrow(presetHHMM) {
      const now = new Date();
      const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 12, 0, 0, 0);
      const [hh, mm] = (presetHHMM || "13:00").split(":").map(n => parseInt(n, 10));
      tomorrow.setHours(hh, mm, 0, 0);
      return toLocalIsoWithOffset(tomorrow);
    }

    function deliverAtLocalIsoInMinutes(minutes) {
      const d = new Date(Date.now() + minutes * 60 * 1000);
      d.setSeconds(0, 0);
      return toLocalIsoWithOffset(d);
    }

    function randomClientRequestId(prefix) {
      return `${prefix}-${Date.now()}-${Math.random().toString(16).slice(2)}`;
    }

    // -------------------------
    // Send handlers
    // -------------------------
    signedCode.addEventListener("input", () => refreshSignedSendEnabled(!!auth.currentUser));
    signedBody.addEventListener("input", () => refreshSignedSendEnabled(!!auth.currentUser));
    rollingCodeInput.addEventListener("input", refreshRollingSendEnabled);
    rollingBodyInput.addEventListener("input", refreshRollingSendEnabled);

    btnSignedSend.addEventListener("click", async () => {
      const user = auth.currentUser;
      const code = signedCode.value.trim();
      const body = signedBody.value.trim();

      if (!user) {
        setStatus("warn", "Sign-in required", "Sign in (Email link or Google) to send Signed messages.");
        return;
      }
      if (!code || !body) {
        setStatus("warn", "Missing details", "Add a code and a message, then try again.");
        return;
      }

      try {
        setStatus("good", "Sending…", "Encrypting in your browser and scheduling delivery…");

        const enc = await encryptBodyForCode(code, body);
        const codeHash = await sha256Hex(enc.normalizedPassphrase);

        let deliverAtLocalIso;
        if (signedMode === "2m") deliverAtLocalIso = deliverAtLocalIsoInMinutes(2);
        else if (signedMode === "3m") deliverAtLocalIso = deliverAtLocalIsoInMinutes(3);
        else if (signedMode === "10m") deliverAtLocalIso = deliverAtLocalIsoInMinutes(10);
        else if (signedMode === "1h") deliverAtLocalIso = deliverAtLocalIsoInMinutes(60);
        else deliverAtLocalIso = deliverAtLocalIsoTomorrow(signedPresetTime);

        const userTimezone = getUserTimezone();
        const clientRequestId = randomClientRequestId("signed");

        const callable = functions.httpsCallable("sendSignedCiphertext");
        await callable({
          codeHash,
          ciphertext: enc.ciphertextB64,
          iv: enc.ivB64,
          salt: enc.saltB64,
          deliverAtLocalIso,
          userTimezone,
          clientRequestId
        });

        setStatus("good", "Scheduled", "Redirecting to Inbox…");
        window.location.href = "./inbox.html";
        return;
      } catch (e) {
        console.error(e);
        const msg = (e && e.message) ? e.message : "Something went wrong while scheduling the message. Try again.";
        setStatus("warn", "Couldn’t send", msg);
      }
    });

    btnRollingSend.addEventListener("click", async () => {
      const code = rollingCodeInput.value.trim();
      const body = rollingBodyInput.value.trim();

      if (!code || !body) {
        setStatus("warn", "Missing details", "Add a rolling code and a message, then try again.");
        return;
      }

      try {
        setStatus("good", "Sending…", "Encrypting in your browser and scheduling delivery…");

        const enc = await encryptBodyForCode(code, body);
        const codeHash = await sha256Hex(enc.normalizedPassphrase);

        const deliverAtLocalIso = deliverAtLocalIsoTomorrow(rollingPresetTime);
        const userTimezone = getUserTimezone();
        const clientRequestId = randomClientRequestId("rolling");

        try {
          const provision = functions.httpsCallable("provisionRollingEnvelope");
          await provision({ codeHash });
        } catch (e) {
          console.warn("[Rolling] provision failed (continuing):", e);
        }

        const callable = functions.httpsCallable("sendRollingCiphertext");
        await callable({
          codeHash,
          ciphertext: enc.ciphertextB64,
          iv: enc.ivB64,
          salt: enc.saltB64,
          deliverAtLocalIso,
          userTimezone,
          clientRequestId
        });

        setStatus("good", "Scheduled", "Redirecting to Inbox…");
        window.location.href = "./inbox.html";
        return;
      } catch (e) {
        console.error(e);
        const code = e && e.code ? e.code : "";
        const msg = (e && e.message) ? e.message : "Something went wrong while scheduling the message. Try again.";
        setStatus("warn", "Couldn’t send", (code ? `${code}: ` : "") + msg);
      }
    });

    btnSignedClear.addEventListener("click", () => {
      signedCode.value = "";
      signedBody.value = "";
      refreshSignedSendEnabled(!!auth.currentUser);
      setStatus("warn", "Cleared", "Signed send fields cleared.");
    });

    btnRollingClear.addEventListener("click", () => {
      rollingCodeInput.value = "";
      rollingBodyInput.value = "";
      refreshRollingSendEnabled();
      setStatus("warn", "Cleared", "Rolling send fields cleared.");
    });

    // Init
    refreshRollingSendEnabled();
    setSignedMode("preset");
    setStatus("good", "Ready", "App Check is active. Encryption + sending are wired.");

    if (window.location.hash && window.location.hash.toLowerCase().includes("signin")) {
      setTab("signed");
    }
  </script>
</body>
</html>
