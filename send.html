<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Send — Setfeed</title>
  <meta name="description" content="Send an end-to-end encrypted message to Setfeed." />
  <meta name="theme-color" content="#0F1114" id="meta-theme-color" />

  <link rel="icon" href="./favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="./favicon-32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="./favicon-16.png" sizes="16x16">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png" sizes="180x180">

  <link rel="stylesheet" href="./styles.css" />

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCECKG-00tijJrt5qvRy3L27ZzE7bocNrU",
      authDomain: "setfeed-fcd7a.firebaseapp.com",
      projectId: "setfeed-fcd7a",
      storageBucket: "setfeed-fcd7a.firebasestorage.app",
      messagingSenderId: "553573263069",
      appId: "1:553573263069:web:e5c9884101ca38eaee1d34"
    };

    const RECAPTCHA_SITE_KEY = "6LfgvG0sAAAAANQjlRbdsWx6GMQw1kP2kuOPjeJI";
    const SITE_ORIGIN = "https://setfeed.app";

    if (!firebase.apps || firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
    const functions = firebase.app().functions("europe-west2");

    function startAppCheck() {
      try {
        firebase.appCheck().activate(RECAPTCHA_SITE_KEY, true);
        console.log("[AppCheck] activated");
      } catch (e) {
        console.warn("[AppCheck] init failed:", e);
      }
    }
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", startAppCheck, { once: true });
    } else {
      startAppCheck();
    }
  </script>

  <!-- THEME -->
  <script>
    (function(){
      const THEME_KEY = "sf_theme_mode";
      const root = document.documentElement;

      function applyTheme(){
        let stored = "system";
        try { stored = localStorage.getItem(THEME_KEY) || "system"; } catch (_) {}

        if (stored === "light" || stored === "dark") root.setAttribute("data-theme", stored);
        else root.removeAttribute("data-theme");

        const effective =
          root.getAttribute("data-theme") ||
          (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");

        const meta = document.getElementById("meta-theme-color");
        if (meta) meta.content = (effective === "dark") ? "#0F1114" : "#FFFBFE";
      }

      applyTheme();
      window.addEventListener("storage", (e) => { if (e && e.key === THEME_KEY) applyTheme(); });
    })();
  </script>

  <style>
    .hidden{ display:none !important; }
    .sf-status-slot{ margin-top: 10px; }

    /* Keep all chips equal height everywhere on this page */
    .chip, .sf-adv-btn{
      min-height: 42px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      padding-top: 0;
      padding-bottom: 0;
    }

    .sf-adv-row{
      display:flex;
      flex-wrap:wrap;
      gap: var(--s-2, 10px);
      margin-top: var(--s-3, 12px);
    }
    .sf-adv-row .sf-adv-btn{
      font: inherit;
      letter-spacing: inherit;
    }
    .sf-adv-row .sf-adv-btn:active{
      transform: none;
      filter: none;
      opacity: 1;
    }

    /* Requested textarea inversion */
    html[data-theme="dark"] #signed-body,
    html[data-theme="dark"] #rolling-body{
      background: #ffffff !important;
      color: #0b0c0f !important;
      border-color: rgba(0,0,0,0.18) !important;
    }
    html[data-theme="light"] #signed-body,
    html[data-theme="light"] #rolling-body{
      background: #0b0c0f !important;
      color: #ffffff !important;
      border-color: rgba(255,255,255,0.18) !important;
    }

    .sf-credits-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content: space-between;
      margin-top: 10px;
    }
    .sf-credits-pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: color-mix(in srgb, var(--surface-variant) 10%, transparent);
      color: var(--text);
      font-weight: var(--fw-medium);
      font-size: 13.2px;
      white-space: nowrap;
    }

    /* Make "Create pulse lobby with Delvee" feel like a link (clickable) */
    .sf-subhead{
      cursor: pointer;
      user-select: none;
      text-align: center;
    }
    .sf-subhead:hover{ text-decoration: underline; }

    /* --------
       Pretty file input (chip)
       -------- */
    .sf-file-row{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
    }
    .sf-file-input{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip: rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }
    .sf-file-chip{
      display:inline-flex;
      align-items:center;
      gap:10px;
      min-height: 42px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: color-mix(in srgb, var(--surface-variant) 12%, transparent);
      color: var(--text);
      font: inherit;
      letter-spacing: inherit;
      cursor: pointer;
      user-select: none;
      max-width: 100%;
    }
    .sf-file-chip:hover{
      background: color-mix(in srgb, var(--surface-variant) 18%, transparent);
    }
    .sf-file-chip:active{
      transform: translateY(0.5px);
    }
    .sf-file-chip:focus-visible{
      outline: 2px solid color-mix(in srgb, var(--primary) 70%, transparent);
      outline-offset: 2px;
    }
    .sf-file-chip .sf-file-dot{
      width: 8px; height: 8px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--primary) 70%, transparent);
      flex: 0 0 auto;
    }
    .sf-file-chip .sf-file-label{
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .sf-file-chip .sf-file-name{
      opacity: 0.75;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: min(360px, 55vw);
    }

    /* --------
       Signed-in email + inbox formatting
       -------- */
    .sf-auth-banner{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: color-mix(in srgb, var(--surface-variant) 10%, transparent);
    }
    .sf-auth-left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .sf-auth-pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid color-mix(in srgb, var(--line) 90%, transparent);
      background: color-mix(in srgb, var(--surface-variant) 14%, transparent);
      font-weight: var(--fw-medium);
      font-size: 13px;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .sf-auth-email{
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      opacity: 0.85;
      font-size: 13px;
    }
    .sf-auth-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 0 0 auto;
    }

    /* Pulse image card spacing (so it doesn’t “loom”) */
    .sf-pulse-image-card{
      margin-bottom: 12px;
    }
  </style>
</head>

<body class="page-bg">
  <header class="site-header">
    <div class="header-inner">
      <a class="brand-mark" href="./" aria-label="Setfeed home">
        <img class="logo" src="./logo.png" alt="" aria-hidden="true" />
      </a>
      <a class="brand-title" href="./">Setfeed</a>

      <nav class="nav" aria-label="Primary">
        <a href="./">Home</a>
        <a href="./send.html" aria-current="page">Send</a>
        <a href="./receive.html">Receive</a>
        <a class="auth-only hidden" href="./inbox.html">Inbox</a>
        <a href="./security.html">Security</a>
        <a href="./privacy.html">Privacy</a>

        <a class="nav-cta" href="https://delvee.app" rel="noreferrer" aria-label="Open Delvee">Download app</a>
      </nav>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <h1>Send a scheduled pulse</h1>
      <p class="lead">
        Notes are encrypted in your browser before they reach Setfeed servers.
        For Delvee pulses and image pulses, credits apply.
      </p>

      <h2>Choose a send type</h2>
      <div class="tabs" role="tablist" aria-label="Send type">
        <button class="tab" id="tab-signed" role="tab" aria-selected="false" aria-controls="panel-signed" type="button">
          Signed (Secure / Personal)
        </button>
        <button class="tab" id="tab-rolling" role="tab" aria-selected="true" aria-controls="panel-rolling" type="button">
          Rolling (no sign-in)
        </button>
      </div>

      <!-- Signed panel -->
      <div id="panel-signed" role="tabpanel" aria-labelledby="tab-signed" class="hidden">
        <div class="row">
          <div class="col" id="signin">
            <!-- Image preview (SIGNED, Pulse mode only) -->
            <div class="sf-pulse-image-card hidden" id="sf-image-card">
              <div class="sf-pulse-image-head">
                <div>
                  <div class="panel-title" style="margin:0;">Image preview</div>
                  <div class="panel-sub" style="margin:6px 0 0 0;">
                    Pulse image requires Delvee credits.
                  </div>
                </div>
              </div>

              <div class="sf-preview" id="sf-preview">
                <div class="sf-preview-empty" id="sf-preview-empty">No image selected.</div>
                <img id="sf-preview-img" class="sf-preview-img hidden" alt="Selected image preview" />
              </div>

              <div class="actions" style="margin-top: 12px;">
                <div class="sf-file-row">
                  <input class="sf-file-input" id="sf-image-file" type="file" accept="image/*" />
                  <label class="sf-file-chip" id="sf-image-chip" for="sf-image-file" role="button" tabindex="0" aria-label="Choose an image file">
                    <span class="sf-file-dot" aria-hidden="true"></span>
                    <span class="sf-file-label">Choose file</span>
                    <span class="sf-file-name" id="sf-image-filename">No file chosen</span>
                  </label>

                  <button class="btn btn-lg btn-primary" id="btn-pulse-image" type="button" disabled>Pulse image</button>
                </div>
              </div>

              <div class="sf-credits-row">
                <small class="help" id="sf-image-help" style="margin-top:0;">
                  Pulse image requires Delvee credits.
                </small>
                <span class="sf-credits-pill" id="sf-credits-pill">Credits: —</span>
              </div>

              <div class="actions" style="margin-top: 10px;">
                <a class="btn btn-secondary" href="https://delvee.app" rel="noreferrer">Get credits</a>
              </div>
            </div>

            <div class="field">
              <label for="signed-email">Email</label>
              <input id="signed-email" type="email" autocomplete="email" placeholder="you@example.com" />
            </div>

            <div class="actions" style="flex-direction: column; align-items: stretch;">
              <button class="btn btn-lg btn-primary" id="btn-google" type="button" aria-label="Continue with Google">
                <span>Google</span>
              </button>

              <button class="btn btn-lg" id="btn-send-link" type="button">Send sign-in link</button>

              <button class="btn btn-lg btn-quiet hidden" id="btn-sign-out" type="button" disabled>Sign out</button>
            </div>

            <div class="sf-auth-banner hidden" id="sf-auth-banner">
              <div class="sf-auth-left">
                <div class="sf-auth-pill" aria-label="Signed in badge">Signed in</div>
                <div class="sf-auth-email" id="sf-auth-label">—</div>
              </div>
              <div class="sf-auth-actions">
                <button class="btn btn-secondary" id="btn-go-inbox" type="button">Go to Inbox</button>
              </div>
            </div>

            <div class="note">
              <p style="margin:0;">
                Signed send requires sign-in (Email link or Google). It is required for Secure and Personal codes.
              </p>
            </div>

            <!-- Top slot for Status when signed in -->
            <div id="status-slot-top" class="sf-status-slot hidden"></div>

            <div class="video-card" id="video-signed" aria-label="Walkthrough">
              <h2 style="margin-top:0;">Walkthrough</h2>
              <p class="lead" style="margin-bottom: 0;">
                A short demonstration of the web send flow. No autoplay. Controls only.
              </p>

              <div class="video-frame">
                <video controls preload="metadata" playsinline poster="./poster.png">
                  <source src="./walkthrough.mp4" type="video/mp4" />
                  Sorry — your browser can’t play this video.
                </video>
              </div>

              <small class="help">
                Demonstration supports clarity. UI stays calm and predictable.
              </small>
            </div>
          </div>

          <div class="col">
            <div class="sf-subhead" id="sf-delvee-cta" role="link" tabindex="0" aria-label="Create pulse lobby with Delvee">
              Create pulse lobby with Delvee
            </div>

            <div class="field" style="margin-top: 10px;">
              <label for="signed-code">Secure or Personal code</label>
              <input id="signed-code" type="text" inputmode="text" placeholder="Paste a Secure (SFS-…) or Personal (SF-…) code" />
            </div>

            <div class="field">
              <label for="signed-body">Add note</label>
              <textarea id="signed-body" maxlength="1200" placeholder="Add a note…"></textarea>
            </div>

            <div class="actions">
              <button class="btn btn-lg btn-primary" id="btn-signed-send" type="button" disabled>Encrypt and send</button>
              <button class="btn btn-lg btn-quiet" id="btn-signed-clear" type="button">Clear</button>
            </div>

            <small class="help">
              Only the recipient device can decrypt. If a code is invalid, you’ll be told explicitly.
            </small>

            <h2>Delivery</h2>
            <div class="panel">
              <p class="panel-sub" id="signed-delivery-sub" style="margin-bottom: var(--s-3);">
                Sign in (Email link or Google) to send Signed (Secure / Personal).
              </p>

              <div class="chips" aria-label="Tomorrow preset times (signed)" id="signed-preset-chips">
                <button class="chip" type="button" aria-pressed="false" data-time="08:00">8am</button>
                <button class="chip" type="button" aria-pressed="true"  data-time="13:00">1pm</button>
                <button class="chip" type="button" aria-pressed="false" data-time="18:00">6pm</button>
              </div>

              <div class="sf-adv-row hidden" id="signed-advanced-row" aria-label="Signed advanced delivery">
                <button class="chip sf-adv-btn" type="button" aria-pressed="true"  data-mode="preset">Tomorrow preset</button>
                <button class="chip sf-adv-btn" type="button" aria-pressed="false" data-mode="pulse">Pulse</button>
                <button class="chip sf-adv-btn" type="button" aria-pressed="false" data-mode="10m">In 10 minutes</button>
                <button class="chip sf-adv-btn" type="button" aria-pressed="false" data-mode="1h">In 1 hour</button>
              </div>

              <small class="help" id="signed-delivery-help" style="margin-top: 10px;">
                Pulse is a short Delvee-style send. Credits may be required for images.
              </small>
            </div>

            <div class="panel" style="margin-top: var(--s-6);">
              <p class="panel-title" style="margin-top:0;">Delvee credits</p>
              <p class="panel-sub">
                You get <b>2 free credits</b> with Setfeed when you sign in with Google (one per user). More credits unlock more pulses.
              </p>

              <div class="actions" style="margin-top: 10px;">
                <a class="btn btn-primary" href="https://delvee.app" rel="noreferrer">Open Delvee</a>
                <button class="btn btn-secondary" id="btn-claim-credits" type="button">Claim free credits</button>
              </div>

              <small class="help" id="sf-credits-help" data-base-currency="GBP" data-p10="2" data-p20="3" data-unlim="3.5">
                Packages: — · — · —
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Rolling panel -->
      <div id="panel-rolling" role="tabpanel" aria-labelledby="tab-rolling">
        <div class="row">
          <div class="col">
            <div class="field">
              <label for="rolling-code">Rolling code</label>
              <input id="rolling-code" type="text" inputmode="text" placeholder="Paste a Rolling code (SFR-…)" />
            </div>

            <div class="video-card" id="video-rolling" aria-label="Walkthrough">
              <h2 style="margin-top:0;">Walkthrough</h2>
              <p class="lead" style="margin-bottom: 0;">
                A short demonstration of the rolling send flow. No autoplay. Controls only.
              </p>

              <div class="video-frame">
                <video controls preload="metadata" playsinline poster="./poster.png">
                  <source src="./walkthrough.mp4" type="video/mp4" />
                  Sorry — your browser can’t play this video.
                </video>
              </div>

              <small class="help">
                Rolling is constrained. Expect explicit errors if expired or over limits.
              </small>
            </div>
          </div>

          <div class="col">
            <div class="field">
              <label for="rolling-body">Add note</label>
              <textarea id="rolling-body" maxlength="1200" placeholder="Add a note…"></textarea>
            </div>

            <div class="actions">
              <button class="btn btn-lg btn-primary" id="btn-rolling-send" type="button" disabled>Encrypt and send</button>
              <button class="btn btn-lg btn-quiet" id="btn-rolling-clear" type="button">Clear</button>
            </div>

            <small class="help">
              Rolling is meant for temporary sharing. It may expire or become invalid after use.
            </small>

            <h2>Delivery (rolling)</h2>
            <div class="panel">
              <p class="panel-sub" style="margin-bottom: var(--s-3);">
                Rolling is constrained to tomorrow at 08:00, 13:00, or 18:00 (your local time).
              </p>
              <div class="chips" aria-label="Tomorrow preset times (rolling)" id="rolling-chips">
                <button class="chip" type="button" aria-pressed="false" data-time="08:00">8am</button>
                <button class="chip" type="button" aria-pressed="true"  data-time="13:00">1pm</button>
                <button class="chip" type="button" aria-pressed="false" data-time="18:00">6pm</button>
              </div>
            </div>

            <h2 style="margin-top: var(--s-6);">What to expect</h2>
            <ul>
              <li>No sign-in required.</li>
              <li>Strict guardrails (validity, usage limits, rate limiting).</li>
              <li>Clear errors when something can’t be sent.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Status container -->
      <div id="status-slot-bottom">
        <h2>Status</h2>
        <div class="status" id="status-box" role="status" aria-live="polite">
          <div class="status-title">
            <span class="dot" id="status-dot"></span>
            <span id="status-title">Not connected</span>
          </div>
          <p class="status-line" id="status-line">Ready.</p>
        </div>
      </div>

      <footer>
        <div>© <span id="y"></span> Setfeed</div>
        <div>
          <a href="./security.html">Security</a>
          <span class="sep">·</span>
          <a href="./privacy.html">Privacy</a>
          <span class="sep">·</span>
          <a href="mailto:security@setfeed.app">security@setfeed.app</a>
        </div>
      </footer>
    </div>
  </div>

  <script>
    document.getElementById("y").textContent = new Date().getFullYear();

    // Tabs
    const tabSigned = document.getElementById("tab-signed");
    const tabRolling = document.getElementById("tab-rolling");
    const panelSigned = document.getElementById("panel-signed");
    const panelRolling = document.getElementById("panel-rolling");

    let userChoseTab = false;

    function setTab(which) {
      const signed = which === "signed";
      tabSigned.setAttribute("aria-selected", signed ? "true" : "false");
      tabRolling.setAttribute("aria-selected", signed ? "false" : "true");
      panelSigned.classList.toggle("hidden", !signed);
      panelRolling.classList.toggle("hidden", signed);
    }
    tabSigned.addEventListener("click", () => { userChoseTab = true; setTab("signed"); });
    tabRolling.addEventListener("click", () => { userChoseTab = true; setTab("rolling"); });

    // Status helper
    const statusDot = document.getElementById("status-dot");
    const statusTitle = document.getElementById("status-title");
    const statusLine = document.getElementById("status-line");
    function setStatus(kind, title, line) {
      statusDot.className = "dot";
      if (kind === "good") statusDot.classList.add("good");
      if (kind === "warn") statusDot.classList.add("warn");
      statusTitle.textContent = title;
      statusLine.textContent = line;
    }

    // Elements
    const signedEmail = document.getElementById("signed-email");
    const signedCode = document.getElementById("signed-code");
    const signedBody = document.getElementById("signed-body");
    const btnSendLink = document.getElementById("btn-send-link");
    const btnGoogle = document.getElementById("btn-google");
    const btnSignOut = document.getElementById("btn-sign-out");
    const btnGoInbox = document.getElementById("btn-go-inbox");
    const btnSignedSend = document.getElementById("btn-signed-send");
    const btnSignedClear = document.getElementById("btn-signed-clear");
    const videoSigned = document.getElementById("video-signed");
    const signedDeliverySub = document.getElementById("signed-delivery-sub");
    const signedDeliveryHelp = document.getElementById("signed-delivery-help");
    const signedAdvancedRow = document.getElementById("signed-advanced-row");
    const authBanner = document.getElementById("sf-auth-banner");
    const authLabel = document.getElementById("sf-auth-label");

    const rollingCodeInput = document.getElementById("rolling-code");
    const rollingBodyInput = document.getElementById("rolling-body");
    const btnRollingSend = document.getElementById("btn-rolling-send");
    const btnRollingClear = document.getElementById("btn-rolling-clear");
    const videoRolling = document.getElementById("video-rolling");

    // Image preview (signed)
    const sfImageCard = document.getElementById("sf-image-card");
    const sfImageFile = document.getElementById("sf-image-file");
    const sfImageFilename = document.getElementById("sf-image-filename");
    const btnPulseImage = document.getElementById("btn-pulse-image");
    const previewEmpty = document.getElementById("sf-preview-empty");
    const previewImg = document.getElementById("sf-preview-img");
    const sfImageHelp = document.getElementById("sf-image-help");
    const creditsPill = document.getElementById("sf-credits-pill");
    const btnClaimCredits = document.getElementById("btn-claim-credits");

    // Clickable subhead -> Delvee
    const delveeCta = document.getElementById("sf-delvee-cta");
    if (delveeCta) {
      const go = () => { window.location.href = "https://delvee.app"; };
      delveeCta.addEventListener("click", go);
      delveeCta.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") go(); });
    }

    // Status movement slots
    const statusBox = document.getElementById("status-box");
    const statusSlotTop = document.getElementById("status-slot-top");
    const statusSlotBottom = document.getElementById("status-slot-bottom");

    // Auth
    const AUTH_KEY = "sf_signed_authed";
    const EMAIL_FOR_SIGNIN_KEY = "sf_email_for_signin";
    const auth = firebase.auth();

    function setSignedAuthedFlag(isAuthed) {
      try { localStorage.setItem(AUTH_KEY, isAuthed ? "true" : "false"); } catch (_) {}
      document.querySelectorAll(".auth-only").forEach(el => el.classList.toggle("hidden", !isAuthed));
    }

    function refreshSignedSendEnabled(isAuthed) {
      const canSend = isAuthed && signedCode.value.trim().length > 0 && signedBody.value.trim().length > 0;
      btnSignedSend.disabled = !canSend;
    }
    function refreshRollingSendEnabled() {
      const canSend = rollingCodeInput.value.trim().length > 0 && rollingBodyInput.value.trim().length > 0;
      btnRollingSend.disabled = !canSend;
    }

    function moveStatusToTop(isAuthed) {
      if (!statusBox || !statusSlotTop || !statusSlotBottom) return;
      if (isAuthed) {
        statusSlotTop.classList.remove("hidden");
        statusSlotBottom.classList.add("hidden");
        statusSlotTop.appendChild(statusBox);
      } else {
        statusSlotTop.classList.add("hidden");
        statusSlotBottom.classList.remove("hidden");
        statusSlotBottom.appendChild(statusBox);
      }
    }

    // -------------------------
    // Credits (Delvee)
    // -------------------------
    let creditsBalance = null; // number | null

    function setCreditsUI(n) {
      if (creditsPill) creditsPill.textContent = (typeof n === "number" && Number.isFinite(n)) ? `Credits: ${n}` : "Credits: —";
      creditsBalance = (typeof n === "number" && Number.isFinite(n)) ? n : null;
      refreshPulseImageEnabled();
    }

    async function loadCredits() {
      if (!auth.currentUser) { setCreditsUI(null); return; }
      try {
        const call = functions.httpsCallable("getDelveeCreditsBalance");
        const res = await call({});
        const data = (res && res.data) ? res.data : {};
        const bal = (typeof data.balance === "number") ? data.balance : (typeof data.credits === "number" ? data.credits : null);
        setCreditsUI((typeof bal === "number") ? bal : null);
      } catch (e) {
        setCreditsUI(null);
      }
    }

    btnClaimCredits.addEventListener("click", async () => {
      if (!auth.currentUser) { setStatus("warn", "Sign-in required", "Sign in with Google to claim free credits."); return; }
      try {
        btnClaimCredits.disabled = true;
        setStatus("good", "Claiming…", "Requesting starter credits…");
        const call = functions.httpsCallable("claimDelveeStarterCredits");
        await call({});
        await loadCredits();
        setStatus("good", "Credits updated", "Starter credits claimed (if eligible).");
      } catch (e) {
        console.warn("[claimDelveeStarterCredits] failed:", e);
        setStatus("warn", "Couldn’t claim", "If you already claimed, this is expected. Otherwise deploy the credits function.");
      } finally {
        btnClaimCredits.disabled = false;
      }
    });

    // -------------------------
    // Scheduling UI
    // -------------------------
    let signedPresetTime = "13:00";
    let signedMode = "preset";
    const signedPresetChips = Array.from(document.querySelectorAll('#signed-preset-chips .chip[data-time]'));
    const signedAdvBtns = Array.from(document.querySelectorAll('#signed-advanced-row .sf-adv-btn[data-mode]'));

    function setSignedPresetHighlightVisible(visible) {
      if (!visible) {
        signedPresetChips.forEach(b => b.setAttribute("aria-pressed", "false"));
        return;
      }
      signedPresetChips.forEach(b => {
        const t = b.getAttribute("data-time") || "";
        b.setAttribute("aria-pressed", (t === signedPresetTime) ? "true" : "false");
      });
    }

    function refreshSignedButtonLabel() {
      // ✅ Rule: only show “Pulse” wording when Pulse mode selected
      btnSignedSend.textContent = (signedMode === "pulse") ? "Pulse text" : "Encrypt and send";
    }

    function setSignedMode(nextMode) {
      signedMode = nextMode || "preset";
      signedAdvBtns.forEach(b => b.setAttribute("aria-pressed", "false"));
      const btn = signedAdvBtns.find(b => (b.getAttribute("data-mode") || "") === signedMode);
      if (btn) btn.setAttribute("aria-pressed", "true");

      if (signedMode !== "preset") setSignedPresetHighlightVisible(false);
      else setSignedPresetHighlightVisible(true);

      // ✅ Only show image preview section in Pulse mode
      if (sfImageCard) sfImageCard.classList.toggle("hidden", signedMode !== "pulse");

      refreshSignedButtonLabel();
      refreshPulseImageEnabled();
    }

    signedPresetChips.forEach(btn => btn.addEventListener("click", () => {
      signedPresetTime = btn.getAttribute("data-time") || "13:00";
      setSignedMode("preset");
    }));
    signedAdvBtns.forEach(btn => btn.addEventListener("click", () => {
      const mode = btn.getAttribute("data-mode") || "preset";
      setSignedMode(mode);
    }));

    let rollingPresetTime = "13:00";
    document.querySelectorAll('#rolling-chips .chip[data-time]').forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll('#rolling-chips .chip[data-time]').forEach(b => b.setAttribute("aria-pressed", "false"));
        btn.setAttribute("aria-pressed", "true");
        rollingPresetTime = btn.getAttribute("data-time") || "13:00";
      });
    });

    // -------------------------
    // Pretty prices (localized formatting)
    // -------------------------
    function guessCurrencyFromLocale() {
      // Heuristic (keeps behavior stable, avoids huge mappings)
      const lang = (navigator.language || "").toLowerCase();
      if (lang.startsWith("en-gb")) return "GBP";
      if (lang.startsWith("en-us")) return "USD";
      if (lang.startsWith("en-ca")) return "CAD";
      if (lang.startsWith("en-au")) return "AUD";
      // Most of Europe browsers will still show EUR nicely
      if (lang.startsWith("de") || lang.startsWith("fr") || lang.startsWith("es") || lang.startsWith("it") || lang.startsWith("nl") || lang.startsWith("pt")) return "EUR";
      return "GBP";
    }

    function fmtMoney(amount, currency) {
      const cur = currency || "GBP";
      try {
        return new Intl.NumberFormat(navigator.language, { style: "currency", currency: cur, maximumFractionDigits: 2 }).format(amount);
      } catch (_) {
        // fallback
        const sym = (cur === "USD") ? "$" : (cur === "EUR") ? "€" : "£";
        return `${sym}${Number(amount).toFixed(2)}`;
      }
    }

    function renderCreditsPricing() {
      const el = document.getElementById("sf-credits-help");
      if (!el) return;

      const base = (el.getAttribute("data-base-currency") || "GBP").toUpperCase();
      const p10 = Number(el.getAttribute("data-p10") || "2");
      const p20 = Number(el.getAttribute("data-p20") || "3");
      const unlim = Number(el.getAttribute("data-unlim") || "3.5");

      // “currency to be based on local time” → interpret as local region/locale display
      const cur = guessCurrencyFromLocale() || base;

      el.textContent =
        `Packages: 10 credits = ${fmtMoney(p10, cur)} · 20 credits = ${fmtMoney(p20, cur)} · unlimited session = ${fmtMoney(unlim, cur)}`;
    }

    // -------------------------
    // Image preview helpers
    // -------------------------
    function setPreviewFile(file) {
      if (!file) {
        if (previewImg) previewImg.src = "";
        if (previewImg) previewImg.classList.add("hidden");
        if (previewEmpty) previewEmpty.classList.remove("hidden");
        if (sfImageFilename) sfImageFilename.textContent = "No file chosen";
        return;
      }
      const url = URL.createObjectURL(file);
      if (previewImg) previewImg.src = url;
      if (previewImg) previewImg.classList.remove("hidden");
      if (previewEmpty) previewEmpty.classList.add("hidden");
      if (sfImageFilename) sfImageFilename.textContent = file.name || "Selected";
    }

    function refreshPulseImageEnabled() {
      const isAuthed = !!auth.currentUser;
      const fileOk = !!(sfImageFile && sfImageFile.files && sfImageFile.files[0]);
      const isPulseMode = (signedMode === "pulse");
      const hasCredits = (typeof creditsBalance === "number" && creditsBalance > 0);

      // ✅ Pulse image requires credits + Pulse mode
      btnPulseImage.disabled = !(isAuthed && fileOk && isPulseMode && hasCredits);

      if (sfImageHelp) {
        if (!isAuthed) sfImageHelp.textContent = "Sign in to pulse images via Delvee.";
        else if (!isPulseMode) sfImageHelp.textContent = "Select “Pulse” to enable image pulses.";
        else if (!hasCredits) sfImageHelp.textContent = "No credits remaining. Get credits in Delvee to pulse images.";
        else sfImageHelp.textContent = "Pulse image requires Delvee credits.";
      }
    }

    if (sfImageFile) {
      sfImageFile.addEventListener("change", () => {
        const f = (sfImageFile.files && sfImageFile.files[0]) ? sfImageFile.files[0] : null;
        setPreviewFile(f);
        refreshPulseImageEnabled();
      });
    }

    btnPulseImage.addEventListener("click", async () => {
      const user = auth.currentUser;
      const file = (sfImageFile && sfImageFile.files && sfImageFile.files[0]) ? sfImageFile.files[0] : null;

      if (!user) { setStatus("warn", "Sign-in required", "Sign in to pulse images via Delvee."); return; }
      if (!file) { setStatus("warn", "No image", "Choose an image first."); return; }
      if (signedMode !== "pulse") { setStatus("warn", "Choose Pulse", "Select Pulse to route images to Delvee."); return; }
      if (!(typeof creditsBalance === "number" && creditsBalance > 0)) {
        setStatus("warn", "No credits", "You need Delvee credits to pulse an image.");
        return;
      }

      setStatus("good", "Opening Delvee…", "Continuing image pulse in Delvee.");
      const url = `https://delvee.app/index.html?from=setfeed&pulse=image`;
      try { window.open(url, "_blank", "noopener"); } catch (_) { window.location.href = url; }
    });

    // -------------------------
    // Guardrail: prevent receive codes in message body
    // -------------------------
    function messageContainsSetfeedReceiveCode(text) {
      const s = String(text || "");
      const hasPrefixed =
        /\bSF\s*-\s*[A-Z0-9]{4}\s*-\s*[A-Z0-9]{4}\b/i.test(s) ||
        /\bSFS\s*-\s*[A-Z0-9]{10,}\b/i.test(s) ||
        /\bSFR\s*-\s*[A-Z0-9]{10,}\b/i.test(s);
      if (hasPrefixed) return true;
      const tokens = s.match(/[A-Za-z0-9]{4,}(?:\s*-\s*[A-Za-z0-9]{4,}){1,}/g) || [];
      return tokens.some(t => {
        const tok = t.replace(/\s+/g, "");
        return /^(?:[A-Z0-9]{4,}-){1,}[A-Z0-9]{4,}$/i.test(tok) && tok.length >= 12;
      });
    }

    function applyBodyGuardrails() {
      const isAuthed = !!auth.currentUser;
      const signedHas = messageContainsSetfeedReceiveCode(signedBody.value);
      const rollingHas = messageContainsSetfeedReceiveCode(rollingBodyInput.value);

      if (signedHas || rollingHas) {
        setStatus("warn", "Not allowed in Setfeed", "That looks like a Setfeed receive code inside the note. Remove the code.");
      }

      const signedBase = isAuthed && signedCode.value.trim().length > 0 && signedBody.value.trim().length > 0;
      btnSignedSend.disabled = !(signedBase && !signedHas);

      const rollingBase = rollingCodeInput.value.trim().length > 0 && rollingBodyInput.value.trim().length > 0;
      btnRollingSend.disabled = !(rollingBase && !rollingHas);

      return { signedOk: !signedHas, rollingOk: !rollingHas };
    }

    // Crypto helpers (WebCrypto)
    function normalizeCodeAndroid(raw) { return raw.trim().toUpperCase().replace(/[\s-]/g, ""); }
    function bytesToB64(bytes) {
      let binary = "";
      const chunk = 0x8000;
      for (let i = 0; i < bytes.length; i += chunk) {
        binary += String.fromCharCode(...bytes.subarray(i, i + chunk));
      }
      return btoa(binary);
    }
    function abToB64(ab) { return bytesToB64(new Uint8Array(ab)); }
    async function sha256Hex(str) {
      const data = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest("SHA-256", data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
    }
    async function deriveAesKeyFromPassphrase(passphrase, saltBytes) {
      const passBytes = new TextEncoder().encode(passphrase);
      const baseKey = await crypto.subtle.importKey("raw", passBytes, { name: "PBKDF2" }, false, ["deriveKey"]);
      return await crypto.subtle.deriveKey(
        { name: "PBKDF2", salt: saltBytes, iterations: 100000, hash: "SHA-256" },
        baseKey,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }
    async function encryptBodyForCode(rawCode, plaintext) {
      const passphrase = normalizeCodeAndroid(rawCode);
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveAesKeyFromPassphrase(passphrase, salt);
      const ptBytes = new TextEncoder().encode(plaintext);
      const ct = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, ptBytes);
      return {
        ciphertextB64: abToB64(ct),
        ivB64: bytesToB64(iv),
        saltB64: bytesToB64(salt),
        normalizedPassphrase: passphrase
      };
    }

    function getUserTimezone() { return Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC"; }
    function pad2(n) { return String(n).padStart(2, "0"); }
    function toLocalIsoWithOffset(date) {
      const d = new Date(date.getTime());
      d.setSeconds(0, 0);
      const offMin = -d.getTimezoneOffset();
      const sign = offMin >= 0 ? "+" : "-";
      const abs = Math.abs(offMin);
      const offH = pad2(Math.floor(abs / 60));
      const offM = pad2(abs % 60);
      const yyyy = d.getFullYear();
      const mon = pad2(d.getMonth() + 1);
      const day = pad2(d.getDate());
      const hour = pad2(d.getHours());
      const minute = pad2(d.getMinutes());
      return `${yyyy}-${mon}-${day}T${hour}:${minute}:00${sign}${offH}:${offM}`;
    }
    function deliverAtLocalIsoTomorrow(presetHHMM) {
      const now = new Date();
      const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 12, 0, 0, 0);
      const [hh, mm] = (presetHHMM || "13:00").split(":").map(n => parseInt(n, 10));
      tomorrow.setHours(hh, mm, 0, 0);
      return toLocalIsoWithOffset(tomorrow);
    }
    function deliverAtLocalIsoInMinutes(minutes) {
      const d = new Date(Date.now() + minutes * 60 * 1000);
      d.setSeconds(0, 0);
      return toLocalIsoWithOffset(d);
    }
    function randomClientRequestId(prefix) { return `${prefix}-${Date.now()}-${Math.random().toString(16).slice(2)}`; }

    // Send handlers (Setfeed)
    signedCode.addEventListener("input", () => { refreshSignedSendEnabled(!!auth.currentUser); applyBodyGuardrails(); });
    signedBody.addEventListener("input", () => { refreshSignedSendEnabled(!!auth.currentUser); applyBodyGuardrails(); });
    rollingCodeInput.addEventListener("input", () => { refreshRollingSendEnabled(); applyBodyGuardrails(); });
    rollingBodyInput.addEventListener("input", () => { refreshRollingSendEnabled(); applyBodyGuardrails(); });

    function renderAuthUI(user) {
      const isAuthed = !!user;

      // default tab behavior (only if user hasn't manually chosen)
      if (!userChoseTab) setTab(isAuthed ? "signed" : "rolling");

      const emailField = signedEmail ? signedEmail.closest(".field") : null;
      if (emailField) emailField.classList.toggle("hidden", isAuthed);
      if (btnSendLink) btnSendLink.classList.toggle("hidden", isAuthed);

      if (btnGoogle) btnGoogle.classList.toggle("hidden", isAuthed);

      if (btnSignOut) {
        btnSignOut.disabled = !isAuthed;
        btnSignOut.classList.toggle("hidden", !isAuthed);
      }

      setSignedAuthedFlag(isAuthed);

      if (videoSigned) videoSigned.classList.toggle("hidden", isAuthed);
      if (videoRolling) videoRolling.classList.toggle("hidden", isAuthed);

      if (signedAdvancedRow) signedAdvancedRow.classList.toggle("hidden", !isAuthed);

      if (authBanner && authLabel) {
        authBanner.classList.toggle("hidden", !isAuthed);
        if (isAuthed) authLabel.textContent = user.email || "Signed in";
      }

      moveStatusToTop(isAuthed);

      if (signedDeliverySub && signedDeliveryHelp) {
        if (isAuthed) {
          signedDeliverySub.textContent = "Signed in: Pulse mode and advanced delivery available.";
          signedDeliveryHelp.textContent = "Pulse is a short Delvee-style send. Credits may be required for images.";
        } else {
          signedDeliverySub.textContent = "Sign in (Email link or Google) to use Signed (Secure / Personal).";
          signedDeliveryHelp.textContent = "Rolling is always available without signing in.";
        }
      }

      // If user signs out while in pulse mode, keep the UI consistent
      if (!isAuthed && signedMode === "pulse") {
        // leave the mode as-is (user chose it), but ensure enable states are correct
        if (sfImageCard) sfImageCard.classList.toggle("hidden", false);
      }

      refreshSignedSendEnabled(isAuthed);
      refreshRollingSendEnabled();
      applyBodyGuardrails();

      loadCredits().catch(() => {});
      refreshPulseImageEnabled();
    }
    auth.onAuthStateChanged((user) => renderAuthUI(user));

    // Google popup
    btnGoogle.addEventListener("click", async () => {
      try {
        setStatus("good", "Signing in…", "Opening Google sign-in…");
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: "select_account" });
        await auth.signInWithPopup(provider);
        setStatus("good", "Signed in", "Signed sends are available.");
      } catch (e) {
        console.error(e);
        setStatus("warn", "Couldn’t sign in", "Google sign-in failed. Check pop-up blocking and try again.");
      }
    });

    // Email link sign-in
    btnSendLink.addEventListener("click", async () => {
      const email = signedEmail.value.trim();
      if (!email) {
        setStatus("warn", "Email needed", "Enter your email to request a sign-in link.");
        return;
      }
      try {
        setStatus("good", "Sending link…", "Check your inbox for the sign-in link.");
        const actionCodeSettings = { url: `${SITE_ORIGIN}/send.html#finishSignIn`, handleCodeInApp: true };
        await auth.sendSignInLinkToEmail(email, actionCodeSettings);
        try { localStorage.setItem(EMAIL_FOR_SIGNIN_KEY, email); } catch (_) {}
        setStatus("good", "Link sent", "Open the link from your email on this device to finish signing in.");
      } catch (e) {
        console.error(e);
        setStatus("warn", "Couldn’t send link", "Email-link sign-in failed. Verify Auth is enabled and your domain is authorized.");
      }
    });

    (async function finishEmailLinkIfPresent(){
      try {
        const href = window.location.href;
        if (!auth.isSignInWithEmailLink(href)) return;

        let email = "";
        try { email = localStorage.getItem(EMAIL_FOR_SIGNIN_KEY) || ""; } catch (_) {}
        if (!email) {
          email = window.prompt("Confirm your email to finish sign-in:");
          if (!email) {
            setStatus("warn", "Sign-in not finished", "Email is required to finish sign-in.");
            return;
          }
        }
        setStatus("good", "Signing in…", "Finishing email-link sign-in…");
        await auth.signInWithEmailLink(email, href);
        try { localStorage.removeItem(EMAIL_FOR_SIGNIN_KEY); } catch (_) {}
        setStatus("good", "Signed in", "Signed sends are available.");
        history.replaceState(null, "", "./send.html#signin");
      } catch (e) {
        console.error(e);
        setStatus("warn", "Sign-in failed", "Couldn’t finish email-link sign-in. Try sending a new link.");
      }
    })();

    btnSignOut.addEventListener("click", async () => {
      try {
        await auth.signOut();
        setStatus("warn", "Signed out", "Signed sending is unavailable until you sign in again.");
      } catch (e) {
        console.error(e);
        setStatus("warn", "Couldn’t sign out", "Try again.");
      }
    });

    btnGoInbox.addEventListener("click", () => { window.location.href = "./inbox.html"; });

    btnSignedSend.addEventListener("click", async () => {
      const user = auth.currentUser;
      const code = signedCode.value.trim();
      const body = signedBody.value.trim();
      const ok = applyBodyGuardrails().signedOk;
      if (!ok) return;

      if (!user) { setStatus("warn", "Sign-in required", "Sign in (Email link or Google) to send Signed messages."); return; }
      if (!code || !body) { setStatus("warn", "Missing details", "Add a code and a note, then try again."); return; }

      try {
        const pulse = (signedMode === "pulse");
        setStatus("good", pulse ? "Pulsing…" : "Sending…", "Encrypting in your browser and scheduling delivery…");

        const enc = await encryptBodyForCode(code, body);
        const codeHash = await sha256Hex(enc.normalizedPassphrase);

        let deliverAtLocalIso;
        if (signedMode === "pulse") deliverAtLocalIso = deliverAtLocalIsoInMinutes(2);
        else if (signedMode === "10m") deliverAtLocalIso = deliverAtLocalIsoInMinutes(10);
        else if (signedMode === "1h") deliverAtLocalIso = deliverAtLocalIsoInMinutes(60);
        else deliverAtLocalIso = deliverAtLocalIsoTomorrow(signedPresetTime);

        const userTimezone = getUserTimezone();
        const clientRequestId = randomClientRequestId("signed");

        const callable = functions.httpsCallable("sendSignedCiphertext");
        await callable({
          codeHash,
          ciphertext: enc.ciphertextB64,
          iv: enc.ivB64,
          salt: enc.saltB64,
          deliverAtLocalIso,
          userTimezone,
          clientRequestId
        });

        setStatus("good", "Scheduled", "Redirecting to Inbox…");
        window.location.href = "./inbox.html";
      } catch (e) {
        console.error(e);
        const msg = (e && e.message) ? e.message : "Something went wrong while scheduling. Try again.";
        setStatus("warn", "Couldn’t send", msg);
      }
    });

    btnRollingSend.addEventListener("click", async () => {
      const code = rollingCodeInput.value.trim();
      const body = rollingBodyInput.value.trim();
      const ok = applyBodyGuardrails().rollingOk;
      if (!ok) return;

      if (!code || !body) { setStatus("warn", "Missing details", "Add a rolling code and a note, then try again."); return; }

      try {
        setStatus("good", "Sending…", "Encrypting in your browser and scheduling delivery…");

        const enc = await encryptBodyForCode(code, body);
        const codeHash = await sha256Hex(enc.normalizedPassphrase);

        const deliverAtLocalIso = deliverAtLocalIsoTomorrow(rollingPresetTime);
        const userTimezone = getUserTimezone();
        const clientRequestId = randomClientRequestId("rolling");

        try {
          const provision = functions.httpsCallable("provisionRollingEnvelope");
          await provision({ codeHash });
        } catch (e) { console.warn("[Rolling] provision failed (continuing):", e); }

        const callable = functions.httpsCallable("sendRollingCiphertext");
        await callable({
          codeHash,
          ciphertext: enc.ciphertextB64,
          iv: enc.ivB64,
          salt: enc.saltB64,
          deliverAtLocalIso,
          userTimezone,
          clientRequestId
        });

        setStatus("good", "Scheduled", "Redirecting to Inbox…");
        window.location.href = "./inbox.html";
      } catch (e) {
        console.error(e);
        const code = e && e.code ? e.code : "";
        const msg = (e && e.message) ? e.message : "Something went wrong while scheduling. Try again.";
        setStatus("warn", "Couldn’t send", (code ? `${code}: ` : "") + msg);
      }
    });

    btnSignedClear.addEventListener("click", () => {
      signedCode.value = ""; signedBody.value = "";
      refreshSignedSendEnabled(!!auth.currentUser); applyBodyGuardrails();
      setStatus("warn", "Cleared", "Signed fields cleared.");
    });
    btnRollingClear.addEventListener("click", () => {
      rollingCodeInput.value = ""; rollingBodyInput.value = "";
      refreshRollingSendEnabled(); applyBodyGuardrails();
      setStatus("warn", "Cleared", "Rolling fields cleared.");
    });

    // Init
    refreshRollingSendEnabled();
    renderCreditsPricing();
    setSignedMode("preset"); // sets button label + hides image card
    applyBodyGuardrails();
    refreshPulseImageEnabled();
    setStatus("good", "Ready", "App Check is active. Encryption + sending are wired.");

    // If user arrived from sign-in flow, prefer signed
    if (window.location.hash && window.location.hash.toLowerCase().includes("signin")) {
      userChoseTab = true;
      setTab("signed");
    }
  </script>
</body>
</html>
