<!-- index.html (FULL FILE REPLACEMENT) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Setfeed</title>
  <meta name="description" content="Setfeed — scheduled messages. Delvee — paid pulse sessions." />

  <meta name="theme-color" content="#FFFBFE" id="meta-theme-color" />

  <link rel="icon" href="./favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="./favicon-32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="./favicon-16.png" sizes="16x16">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png" sizes="180x180">

  <link rel="stylesheet" href="./styles.css" />

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCECKG-00tijJrt5qvRy3L27ZzE7bocNrU",
      authDomain: "setfeed-fcd7a.firebaseapp.com",
      projectId: "setfeed-fcd7a",
      storageBucket: "setfeed-fcd7a.firebasestorage.app",
      messagingSenderId: "553573263069",
      appId: "1:553573263069:web:e5c9884101ca38eaee1d34"
    };

    const RECAPTCHA_SITE_KEY = "6LfgvG0sAAAAANQjlRbdsWx6GMQw1kP2kuOPjeJI";

    if (!firebase.apps || firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);

    window.sfAuth = firebase.auth();
    window.sfFunctions = firebase.app().functions("europe-west2");

    // ✅ Set persistence early
    window.sfAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(() => {});

    function startAppCheck() {
      try {
        firebase.appCheck().activate(RECAPTCHA_SITE_KEY, true);
        console.log("[AppCheck] activated");
      } catch (e) {
        console.warn("[AppCheck] init failed:", e);
      }
    }
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", startAppCheck, { once: true });
    } else {
      startAppCheck();
    }
  </script>

  <!-- THEME -->
  <script>
    (function(){
      const THEME_KEY = "sf_theme_mode";
      const root = document.documentElement;

      function applyTheme(){
        let stored = "system";
        try { stored = localStorage.getItem(THEME_KEY) || "system"; } catch (_) {}

        if (stored === "light" || stored === "dark") root.setAttribute("data-theme", stored);
        else root.removeAttribute("data-theme");

        const effective =
          root.getAttribute("data-theme") ||
          (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");

        const meta = document.getElementById("meta-theme-color");
        if (meta) meta.content = (effective === "dark") ? "#0F1114" : "#FFFBFE";
      }

      applyTheme();
      window.addEventListener("storage", (e) => { if (e && e.key === THEME_KEY) applyTheme(); });
    })();
  </script>

  <style>
    .hidden{ display:none !important; }

    .sf-hero-2col{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: var(--s-6);
      align-items:start;
      margin-top: var(--s-5);
    }
    @media (max-width: 860px){
      .sf-hero-2col{ grid-template-columns: 1fr; }
    }

    .sf-kicker{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: color-mix(in srgb, var(--surface-variant) 10%, transparent);
      color: var(--soft);
      font-size: 13px;
      margin-bottom: var(--s-3);
    }

    .sf-price-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .sf-price-card{
      border-radius: var(--radius-2);
      border: 1px solid var(--line);
      background: color-mix(in srgb, var(--surface-variant) 10%, transparent);
      padding: 14px;
    }
    .sf-price-top{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:baseline;
    }
    .sf-price-name{ font-weight: var(--fw-medium); color: var(--text); }
    .sf-price-val{ font-weight: var(--fw-medium); color: var(--text); }
    .sf-price-sub{ margin: 6px 0 0 0; font-size: 13.6px; color: var(--muted); line-height: 1.55; }

    .sf-price-actions{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .sf-auth-pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(233,238,246,0.9);
      font-weight: 600;
      font-size: 13px;
    }
    :root[data-theme="light"] .sf-auth-pill{
      border-color: rgba(0,0,0,0.10);
      background: rgba(0,0,0,0.03);
      color: rgba(28,27,31,0.90);
    }

    .sf-mini{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.6;
      margin-top: 10px;
    }

    .sf-pay-status{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.6;
    }
    .sf-danger{
      color: color-mix(in srgb, #ff4d4d 70%, var(--text));
    }

    .sf-plans{
      margin-top: var(--s-7);
      scroll-margin-top: 90px;
    }
    .sf-plan-detail{
      border-radius: var(--radius-2);
      border: 1px solid var(--line);
      background: color-mix(in srgb, var(--surface-variant) 10%, transparent);
      padding: 16px;
      margin-top: 12px;
    }
    .sf-plan-detail h3{
      margin: 0 0 6px 0;
      font-size: 16px;
      color: var(--text);
    }
    .sf-plan-detail p{
      margin: 0;
      color: var(--muted);
      line-height: 1.6;
      font-size: 13.6px;
    }
    .sf-bullets{
      margin: 10px 0 0 0;
      padding-left: 18px;
      color: var(--muted);
      line-height: 1.6;
      font-size: 13.6px;
    }
    .sf-bullets li{ margin: 4px 0; }
  </style>
</head>

<body class="page-bg">
  <header class="site-header">
    <div class="header-inner">
      <a class="brand-mark" href="./" aria-label="Setfeed home">
        <img class="logo" src="./logo.png" alt="" aria-hidden="true" />
      </a>

      <a class="brand-title" href="./">Setfeed</a>

      <nav class="nav" aria-label="Primary">
        <a href="./" aria-current="page">Home</a>
        <a href="./send.html">Send</a>
        <a href="./receive.html">Receive</a>
        <a class="auth-only hidden" href="./inbox.html">Inbox</a>
        <a href="./security.html">Security</a>
        <a href="./privacy.html">Privacy</a>

        <a class="nav-cta" href="https://delvee.app" rel="noreferrer" aria-label="Open Delvee">Open Delvee</a>
      </nav>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="sf-kicker">Setfeed → send · Delvee → paid pulses</div>

      <h1>Send scheduled messages.</h1>
      <p class="lead">
        Use Setfeed web to send encrypted scheduled messages.
        If you want <b>pulsed messaging</b> sessions, images, and summaries — that’s <b>Delvee</b>.
      </p>

      <div class="sf-hero-2col">
        <div>
          <div class="actions" style="margin-top: 0;">
            <a class="btn btn-lg btn-primary" href="./send.html">Send a message</a>
            <a class="btn btn-lg btn-secondary" href="./receive.html">Get a receive code</a>
            <a class="btn btn-lg btn-quiet" href="./security.html">Security</a>
          </div>

          <div class="panel" style="margin-top: var(--s-6);">
            <p class="panel-title" style="margin-top:0;">Delvee plans</p>
            <p class="panel-sub">
              Choose a plan for your pulse experience. Tap <b>See more</b> for plan details.
            </p>

            <div class="sf-price-grid" aria-label="Delvee pricing">
              <div class="sf-price-card">
                <div class="sf-price-top">
                  <div class="sf-price-name">Setfeed Private</div>
                  <div class="sf-price-val">£2.99 / month</div>
                </div>
                <p class="sf-price-sub">Private pulses for 1:1 sessions.</p>
                <div class="sf-price-actions">
                  <button class="btn btn-primary auth-only hidden" id="buy-private" type="button">Purchase</button>
                  <a class="btn btn-secondary no-auth-only" href="#signin">Sign in</a>
                </div>
              </div>

              <div class="sf-price-card">
                <div class="sf-price-top">
                  <div class="sf-price-name">Setfeed Lobbies</div>
                  <div class="sf-price-val">£4.99 / month</div>
                </div>
                <p class="sf-price-sub">Join lobbies and run group pulses.</p>
                <div class="sf-price-actions">
                  <button class="btn btn-primary auth-only hidden" id="buy-lobbies" type="button">Purchase</button>
                  <a class="btn btn-secondary no-auth-only" href="#signin">Sign in</a>
                </div>
              </div>

              <div class="sf-price-card">
                <div class="sf-price-top">
                  <div class="sf-price-name">Setfeed Max</div>
                  <div class="sf-price-val">£6.99 / month</div>
                </div>
                <p class="sf-price-sub">Everything included (Private + Lobbies).</p>
                <div class="sf-price-actions">
                  <button class="btn btn-primary auth-only hidden" id="buy-max" type="button">Purchase</button>
                  <a class="btn btn-secondary no-auth-only" href="#signin">Sign in</a>
                </div>
              </div>
            </div>

            <div class="actions" style="margin-top: 12px;">
              <a class="btn btn-lg btn-quiet" id="btn-see-more" href="#plans">See more</a>
            </div>

            <div class="sf-pay-status hidden" id="sf-pay-status" aria-live="polite"></div>

            <small class="help">
              Web checkout is for Stripe testing. The Android app can use Google Play Billing separately.
            </small>
          </div>

          <div class="panel no-auth-only" id="signin" style="margin-top: var(--s-6);">
            <p class="panel-title">Sign in</p>
            <p class="panel-sub">Sign in with Google to buy a plan and to see Delvee credit balance.</p>

            <div class="actions">
              <button class="btn btn-lg btn-primary" id="btn-google" type="button">Continue with Google</button>
              <a class="btn btn-lg btn-secondary" id="btn-email" href="./send.html#signin">Continue with email</a>
            </div>

            <div class="sf-pay-status hidden" id="sf-auth-status" aria-live="polite"></div>

            <small class="help">Rolling is always available without signing in.</small>
          </div>

          <div class="panel auth-only hidden" style="margin-top: var(--s-6);">
            <p class="panel-title">Signed in</p>

            <div style="margin-top: 10px;">
              <span class="sf-auth-pill" id="sf-auth-pill">
                <span aria-hidden="true">✓</span>
                <span id="sf-auth-label">Signed in</span>
              </span>
            </div>

            <div class="sf-mini" id="sf-credits-line">Delvee credits: —</div>

            <div class="actions" style="margin-top: 12px;">
              <button class="btn btn-lg btn-quiet" id="btn-signout" type="button">Sign out</button>
            </div>
          </div>

          <section class="sf-plans" id="plans">
            <h2 style="margin:0;">Plan details</h2>
            <p class="sf-mini" style="margin-top:8px;">
              All plans unlock paid pulse experiences in Delvee. Cancel anytime from the Stripe billing portal.
            </p>

            <div class="sf-plan-detail">
              <h3>Setfeed Private — £2.99 / month</h3>
              <p>For 1:1 pulse sessions where privacy is the priority.</p>
              <ul class="sf-bullets">
                <li>Unlimited private pulse sessions</li>
                <li>Ideal for personal conversations</li>
                <li>Best entry plan</li>
              </ul>
            </div>

            <div class="sf-plan-detail">
              <h3>Setfeed Lobbies — £4.99 / month</h3>
              <p>For group sessions and shared spaces (“lobbies”).</p>
              <ul class="sf-bullets">
                <li>Unlimited lobby pulses</li>
                <li>Create/join group lobbies</li>
                <li>Good for communities</li>
              </ul>
            </div>

            <div class="sf-plan-detail">
              <h3>Setfeed Max — £6.99 / month</h3>
              <p>Everything: Private + Lobbies in one plan.</p>
              <ul class="sf-bullets">
                <li>Unlimited private sessions</li>
                <li>Unlimited lobbies</li>
                <li>Best value for power users</li>
              </ul>
            </div>
          </section>
        </div>

        <aside class="panel">
          <p class="panel-title">What’s the “Open Delvee” button?</p>
          <p class="panel-sub">
            Right now it opens Delvee — the paid pulse experience. You can ship Android/web first, no iOS required.
          </p>

          <div class="note">
            <p style="margin:0;">
              Setfeed web focuses on sending. Delvee is where you host/join lobbies.
            </p>
          </div>
        </aside>
      </div>

      <footer>
        <div>© <span id="y"></span> Setfeed</div>
        <div>
          <a href="./security.html">Security</a>
          <span class="sep">·</span>
          <a href="./privacy.html">Privacy</a>
          <span class="sep">·</span>
          <a href="mailto:security@setfeed.app">security@setfeed.app</a>
        </div>
      </footer>
    </div>
  </div>

  <script>
    document.getElementById("y").textContent = new Date().getFullYear();

    const auth = window.sfAuth;
    const functions = window.sfFunctions;

    function setSignedAuthedFlag(isAuthed) {
      document.querySelectorAll(".auth-only").forEach(el => el.classList.toggle("hidden", !isAuthed));
      document.querySelectorAll(".no-auth-only").forEach(el => el.classList.toggle("hidden", isAuthed));
    }

    const btnGoogle = document.getElementById("btn-google");
    const btnSignout = document.getElementById("btn-signout");
    const pillLabel = document.getElementById("sf-auth-label");
    const creditsLine = document.getElementById("sf-credits-line");
    const payStatus = document.getElementById("sf-pay-status");
    const authStatus = document.getElementById("sf-auth-status");

    function setStatus(el, msg, isError) {
      if (!el) return;
      if (!msg) {
        el.classList.add("hidden");
        el.textContent = "";
        el.classList.remove("sf-danger");
        return;
      }
      el.classList.remove("hidden");
      el.textContent = msg;
      el.classList.toggle("sf-danger", !!isError);
    }
    function setPayStatus(msg, isError) { setStatus(payStatus, msg, isError); }
    function setAuthStatus(msg, isError) { setStatus(authStatus, msg, isError); }

    function setCreditsLine(n) {
      if (!creditsLine) return;
      if (typeof n === "number" && Number.isFinite(n)) creditsLine.textContent = `Delvee credits: ${n}`;
      else creditsLine.textContent = "Delvee credits: —";
    }

    async function loadCredits() {
      if (!auth.currentUser) { setCreditsLine(null); return; }
      try {
        const call = functions.httpsCallable("getDelveeCreditsBalance");
        const res = await call({});
        const data = (res && res.data) ? res.data : {};
        const bal = (typeof data.balance === "number") ? data.balance : (typeof data.credits === "number" ? data.credits : null);
        setCreditsLine((typeof bal === "number") ? bal : null);
      } catch (e) {
        setCreditsLine(null);
      }
    }

    function renderAuthed(user) {
      const isAuthed = !!user;
      setSignedAuthedFlag(isAuthed);
      setPayStatus("", false);
      setAuthStatus("", false);

      if (isAuthed && pillLabel) pillLabel.textContent = user.email || "Signed in";
      loadCredits().catch(() => {});
    }

    auth.onAuthStateChanged((user) => renderAuthed(user));

    // ✅ Finalize redirect result (if popup fallback went to redirect)
    auth.getRedirectResult().catch((e) => {
      console.error(e);
      const code = (e && e.code) ? String(e.code) : "";
      if (code === "auth/unauthorized-domain") {
        setAuthStatus("This domain isn’t authorized for Firebase Auth. Add setfeed.app in Firebase Console → Authentication → Settings → Authorized domains.", true);
      } else if (code) {
        setAuthStatus(`Google sign-in failed: ${code}`, true);
      }
    });

    async function doGoogleSignInPopupFirst() {
      setAuthStatus("", false);

      if (!auth) {
        setAuthStatus("Auth failed to initialize (firebase-auth not loaded).", true);
        return;
      }
      if (auth.currentUser) return;

      try { await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch (_) {}

      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: "select_account" });

      try {
        setAuthStatus("Opening Google sign-in…", false);
        await auth.signInWithPopup(provider);
      } catch (e) {
        console.warn("[popup] failed, falling back to redirect:", e);

        const code = (e && e.code) ? String(e.code) : "";
        if (code === "auth/unauthorized-domain") {
          setAuthStatus("This domain isn’t authorized for Firebase Auth. Add setfeed.app in Firebase Auth → Authorized domains.", true);
          return;
        }

        try {
          await auth.signInWithRedirect(provider);
        } catch (err) {
          console.error(err);
          const c = (err && err.code) ? String(err.code) : "";
          setAuthStatus(c ? `Couldn’t sign in: ${c}` : "Couldn’t sign in. Check console.", true);
        }
      }
    }

    btnGoogle.addEventListener("click", (ev) => {
      ev.preventDefault();
      doGoogleSignInPopupFirst();
    });

    btnSignout.addEventListener("click", async () => {
      try { await auth.signOut(); } catch (e) {
        console.error(e);
        alert("Couldn’t sign out. Try again.");
      }
    });

    // Stripe Checkout (callable)
    const LOOKUP_KEYS = {
      private: "delvee_private_unlimited_monthly",
      lobbies: "delvee_lobby_unlimited_monthly",
      max: "delvee_both_unlimited_monthly",
    };

    async function startStripeCheckout(lookupKey) {
      if (!auth.currentUser) {
        setPayStatus("Please sign in first.", true);
        location.hash = "#signin";
        return;
      }

      setPayStatus("Opening Stripe Checkout…", false);

      try {
        const call = functions.httpsCallable("createStripeCheckoutSession");
        const res = await call({ lookupKey });
        const data = (res && res.data) ? res.data : null;
        const url = data && typeof data.url === "string" ? data.url : "";

        if (!url) {
          setPayStatus("Checkout session did not return a URL.", true);
          return;
        }
        window.location.href = url;
      } catch (e) {
        console.error(e);
        setPayStatus("Couldn’t start checkout. Check your function deploy + App Check settings.", true);
      }
    }

    function wireBuy(btnId, lookupKey) {
      const btn = document.getElementById(btnId);
      if (!btn) return;
      btn.addEventListener("click", async () => {
        btn.disabled = true;
        try { await startStripeCheckout(lookupKey); }
        finally { btn.disabled = false; }
      });
    }

    wireBuy("buy-private", LOOKUP_KEYS.private);
    wireBuy("buy-lobbies", LOOKUP_KEYS.lobbies);
    wireBuy("buy-max", LOOKUP_KEYS.max);

    // Smooth scroll for "See more"
    const seeMore = document.getElementById("btn-see-more");
    if (seeMore) {
      seeMore.addEventListener("click", (e) => {
        const target = document.getElementById("plans");
        if (!target) return;
        e.preventDefault();
        target.scrollIntoView({ behavior: "smooth", block: "start" });
        history.replaceState(null, "", "#plans");
      });
    }
  </script>
</body>
</html>
