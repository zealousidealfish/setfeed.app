<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Receive — Setfeed</title>
  <meta name="description" content="How to find your Setfeed receive codes in the app and choose the right type." />

  <meta name="theme-color" content="#FFFBFE" id="meta-theme-color" />

  <link rel="icon" href="./favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="./favicon-32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="./favicon-16.png" sizes="16x16">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png" sizes="180x180">

  <link rel="stylesheet" href="./styles.css" />

  <!-- FIREBASE (AUTH + FUNCTIONS) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCECKG-00tijJrt5qvRy3L27ZzE7bocNrU",
      authDomain: "setfeed-fcd7a.firebaseapp.com",
      projectId: "setfeed-fcd7a",
      storageBucket: "setfeed-fcd7a.firebasestorage.app",
      messagingSenderId: "553573263069",
      appId: "1:553573263069:web:e5c9884101ca38eaee1d34"
    };

    if (!firebase.apps || firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);

    const functions = firebase.app().functions("europe-west2");
    const auth = firebase.auth();
  </script>

  <!-- THEME -->
  <script>
    (function(){
      const themeKey = "sf_theme_mode";
      const root = document.documentElement;

      function applyTheme(){
        const stored = localStorage.getItem(themeKey) || "system";
        if (stored === "light" || stored === "dark") root.setAttribute("data-theme", stored);
        else root.removeAttribute("data-theme");

        const effective =
          root.getAttribute("data-theme") ||
          (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");

        const meta = document.getElementById("meta-theme-color");
        if (meta) meta.content = (effective === "dark") ? "#0F1114" : "#FFFBFE";
      }

      applyTheme();
      window.addEventListener("storage", (e) => { if (e && e.key === themeKey) applyTheme(); });
    })();
  </script>

  <style>
    .hidden{ display:none !important; }

    .code-grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    @media (min-width: 840px){ .code-grid{ grid-template-columns:1fr 1fr 1fr; } }
    .code-card{ border-radius:16px; padding:12px; border:1px solid rgba(0,0,0,0.08); background:rgba(0,0,0,0.02); }
    [data-theme="dark"] .code-card{ border-color:rgba(255,255,255,0.10); background:rgba(255,255,255,0.06); }
    .code-label{ font-weight: 600; margin:0 0 8px 0; color: var(--text); }
    .code-box{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.75);
      word-break: break-all;
      text-align: center;
      color: var(--text);
    }
    [data-theme="dark"] .code-box{ border-color: rgba(255,255,255,0.12); background: rgba(15,17,20,0.55); }
    .mini{ font-size:12px; opacity:0.85; margin-top:8px; line-height:1.35; color: var(--muted); }
    .row-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center; justify-content:space-between; }
    .row-actions .left, .row-actions .right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .statusline{ margin-top:10px; font-size:13px; opacity:0.9; color: var(--muted); }

    /* Delvee prefs */
    .prefs-grid{ display:grid; grid-template-columns:1fr; gap:10px; margin-top: 10px; }
    @media (min-width: 840px){ .prefs-grid{ grid-template-columns: 1.2fr 1fr; } }
    .prefs-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .prefs-left{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .prefs-right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .sf-select, .sf-input{
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.85);
      color: var(--text);
      min-width: 220px;
    }
    [data-theme="dark"] .sf-select, [data-theme="dark"] .sf-input{
      border-color: rgba(255,255,255,0.12);
      background: rgba(15,17,20,0.55);
    }
    .sf-switch{
      display:flex; align-items:center; gap:10px;
      border: 1px solid rgba(0,0,0,0.10);
      background: rgba(0,0,0,0.02);
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      user-select:none;
    }
    [data-theme="dark"] .sf-switch{
      border-color: rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }
    .sf-switch input{ transform: scale(1.1); }
    .prefs-note{ font-size: 12px; opacity: 0.85; line-height: 1.35; color: var(--muted); margin-top: 8px; }
  </style>
</head>

<body class="page-bg">
  <header class="site-header">
    <div class="header-inner">
      <a class="brand-mark" href="./" aria-label="Setfeed home">
        <img class="logo" src="./logo.png" alt="" aria-hidden="true" />
      </a>
      <a class="brand-title" href="./">Setfeed</a>
      <nav class="nav" aria-label="Primary">
        <a href="./">Home</a>
        <a href="./send.html">Send</a>
        <a href="./receive.html" aria-current="page">Receive</a>
        <a class="auth-only hidden" href="./inbox.html">Inbox</a>
        <a href="./security.html">Security</a>
        <a href="./privacy.html">Privacy</a>
        <a class="nav-cta" href="#" aria-label="Download Setfeed app">Download app</a>
      </nav>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="hero">
        <div>
          <h1>Get a receive code.</h1>
          <p class="lead">
            A receive code is the address. If someone has your code, they can send you an encrypted message through setfeed.app.
          </p>

          <!-- Signed-in web codes panel -->
          <section class="panel auth-only hidden" aria-label="Web receive codes">
            <p class="panel-title">Your codes (web)</p>
            <p class="panel-sub" style="margin-bottom: var(--s-3);">
              You’re signed in. Load and share your receive codes.
            </p>

            <div class="row-actions">
              <div class="left">
                <button class="btn btn-primary" id="btn-load-codes" type="button">Load codes</button>
                <button class="btn btn-quiet" id="btn-refresh-rolling" type="button" disabled>Refresh rolling</button>
              </div>
              <div class="right">
                <button class="btn btn-secondary" id="btn-copy-personal" type="button" disabled>Copy Personal</button>
                <button class="btn btn-secondary" id="btn-copy-secure" type="button" disabled>Copy Secure</button>
                <button class="btn btn-secondary" id="btn-copy-rolling" type="button" disabled>Copy Rolling</button>
              </div>
            </div>

            <div class="statusline" id="codes-status">Ready.</div>

            <div class="code-grid" id="codes-grid" aria-live="polite">
              <div class="code-card">
                <p class="code-label">Personal</p>
                <div class="code-box" id="code-personal">—</div>
                <div class="mini">Friendly format. Signed send. Best for trusted sharing.</div>
              </div>

              <div class="code-card">
                <p class="code-label">Secure</p>
                <div class="code-box" id="code-secure">—</div>
                <div class="mini">High-entropy. Signed send. Best default.</div>
              </div>

              <div class="code-card">
                <p class="code-label">Rolling</p>
                <div class="code-box" id="code-rolling">—</div>
                <div class="mini" id="code-rolling-meta">Temporary. Expiry / limits may apply.</div>
              </div>
            </div>
          </section>

          <!-- ✅ Delvee summaries prefs (signed-in only) -->
          <section class="panel auth-only hidden" aria-label="Delvee summaries">
            <p class="panel-title">Delvee pulse summaries</p>
            <p class="panel-sub">
              If enabled, Delvee will send a session summary into your Setfeed destination.
            </p>

            <div class="prefs-row" style="margin-top: var(--s-3);">
              <label class="sf-switch" for="dv-enabled">
                <input id="dv-enabled" type="checkbox" />
                <span>Receive Delvee summaries</span>
              </label>

              <div class="prefs-right">
                <button class="btn btn-quiet" id="dv-reload" type="button">Reload</button>
                <button class="btn btn-primary" id="dv-save" type="button">Save</button>
              </div>
            </div>

            <div class="prefs-grid">
              <div>
                <label class="mini" for="dv-dest" style="display:block; margin-bottom:6px;">Destination</label>
                <select id="dv-dest" class="sf-select">
                  <option value="setfeed_web_inbox">Setfeed website inbox (this account)</option>
                  <option value="setfeed_app_code">Setfeed app (paste a receive code)</option>
                </select>

                <div class="prefs-note">
                  Website inbox uses your account’s receive codes. App destination uses a specific code you paste below.
                </div>
              </div>

              <div id="dv-web-box">
                <label class="mini" for="dv-web-type" style="display:block; margin-bottom:6px;">Website inbox code</label>
                <select id="dv-web-type" class="sf-select">
                  <option value="secure">Secure (recommended)</option>
                  <option value="personal">Personal</option>
                </select>

                <div class="prefs-note">
                  This decides which of your web codes Delvee targets when delivering into Inbox.
                </div>
              </div>

              <div id="dv-app-box" class="hidden">
                <label class="mini" for="dv-app-code" style="display:block; margin-bottom:6px;">App receive code</label>
                <input id="dv-app-code" class="sf-input" placeholder="Paste SF-… or SFS-… (app)" />

                <div class="prefs-note">
                  Tip: use an app Secure code (SFS-…). Delvee will normalize it automatically.
                </div>
              </div>
            </div>

            <div class="statusline" id="dv-status">Ready.</div>
          </section>

          <!-- Not signed in helper -->
          <section class="panel auth-off" aria-label="Sign in for web codes">
            <p class="panel-title">Want codes on web?</p>
            <p class="panel-sub">
              Sign in on the Send page to enable web receive codes and inbox access.
            </p>
            <div class="actions">
              <a class="btn btn-lg btn-primary" href="./send.html#signin">Sign in</a>
              <a class="btn btn-lg btn-quiet" href="./send.html">Go to Send</a>
            </div>
          </section>

          <h2 style="margin-top: var(--s-7);">Where to find codes (app)</h2>
          <p>
            In the Setfeed app: <strong>Settings → Receive codes</strong>.
            You’ll see three types. Each has a different safety model.
          </p>

          <h2>Choose the right type</h2>
          <ul>
            <li><strong>Secure</strong>: signed send. Best for yourself or trusted sharing.</li>
            <li><strong>Personal</strong>: signed send. Friendly format, still requires sign-in.</li>
            <li><strong>Rolling</strong>: temporary. No sign-in, but constrained (expiry / limits).</li>
          </ul>

          <div class="note">
            <p style="margin:0;">
              If you’re unsure, use <strong>Secure</strong>. It’s designed for stable use with explicit controls.
            </p>
          </div>
        </div>

        <aside class="panel">
          <p class="panel-title">Next step</p>
          <p class="panel-sub">
            Once you have a code, open the send form and paste it in.
          </p>

          <div class="actions">
            <a class="btn btn-lg btn-primary" href="./send.html">Send to a code</a>
            <a class="btn btn-lg btn-quiet" href="./security.html">Read security</a>
          </div>

          <small class="help">
            Tip: codes start with prefixes like <strong>SF-</strong>, <strong>SFS-</strong>, or <strong>SFR-</strong>.
          </small>
        </aside>
      </div>

      <footer>
        <div>© <span id="y"></span> Setfeed</div>
        <div>
          <a href="./send.html">Send</a>
          <span class="sep">·</span>
          <a href="./security.html">Security</a>
          <span class="sep">·</span>
          <a href="./privacy.html">Privacy</a>
        </div>
      </footer>
    </div>
  </div>

  <script>
    document.getElementById("y").textContent = new Date().getFullYear();

    function applyAuthVisibility(isAuthed){
      document.querySelectorAll(".auth-only").forEach(el => el.classList.toggle("hidden", !isAuthed));
      document.querySelectorAll(".auth-off").forEach(el => el.classList.toggle("hidden", isAuthed));
      try { localStorage.setItem("sf_signed_authed", isAuthed ? "true" : "false"); } catch (_) {}
    }

    auth.onAuthStateChanged((user) => {
      applyAuthVisibility(!!user);
      if (user) {
        loadDelveePrefs().catch(() => {});
      }
    });

    // ---------------------------
    // Web receive codes section
    // ---------------------------
    const btnLoad = document.getElementById("btn-load-codes");
    const btnRefreshRolling = document.getElementById("btn-refresh-rolling");

    const boxPersonal = document.getElementById("code-personal");
    const boxSecure = document.getElementById("code-secure");
    const boxRolling = document.getElementById("code-rolling");
    const rollingMeta = document.getElementById("code-rolling-meta");
    const codesStatus = document.getElementById("codes-status");

    const btnCopyPersonal = document.getElementById("btn-copy-personal");
    const btnCopySecure = document.getElementById("btn-copy-secure");
    const btnCopyRolling = document.getElementById("btn-copy-rolling");

    let lastCodes = null;

    function setCodesStatus(text){ if (codesStatus) codesStatus.textContent = text || "Ready."; }

    function setCopyEnabled(enabled){
      btnCopyPersonal.disabled = !enabled;
      btnCopySecure.disabled = !enabled;
      btnCopyRolling.disabled = !enabled;
      btnRefreshRolling.disabled = !enabled;
    }

    async function copyText(text){
      const t = (text || "").trim();
      if (!t || t === "—") return;
      try {
        await navigator.clipboard.writeText(t);
        setCodesStatus("Copied.");
      } catch (_) {
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        try { document.execCommand("copy"); setCodesStatus("Copied."); } catch (_) { setCodesStatus("Couldn’t copy."); }
        document.body.removeChild(ta);
      }
    }

    btnCopyPersonal.addEventListener("click", () => copyText(boxPersonal.textContent));
    btnCopySecure.addEventListener("click", () => copyText(boxSecure.textContent));
    btnCopyRolling.addEventListener("click", () => copyText(boxRolling.textContent));

    function renderCodes(c){
      lastCodes = c;

      boxPersonal.textContent = (c && c.personal && c.personal.code) ? c.personal.code : "—";
      boxSecure.textContent = (c && c.secure && c.secure.code) ? c.secure.code : "—";
      boxRolling.textContent = (c && c.rolling && c.rolling.code) ? c.rolling.code : "—";

      const exp = (c && c.rolling) ? c.rolling.expiresAtMillis : null;
      if (exp) {
        const d = new Date(exp);
        rollingMeta.textContent = `Expires: ${d.toLocaleString()}`;
      } else {
        rollingMeta.textContent = "Temporary. Expiry / limits may apply.";
      }

      const ok =
        (boxPersonal.textContent !== "—") ||
        (boxSecure.textContent !== "—") ||
        (boxRolling.textContent !== "—");

      setCopyEnabled(ok);
    }

    async function loadCodes(){
      const user = auth.currentUser;
      if (!user) { setCodesStatus("Sign in first."); return; }

      try {
        setCodesStatus("Loading codes…");
        const callable = functions.httpsCallable("getReceiveCodes");
        const res = await callable({});
        renderCodes(res && res.data ? res.data : null);
        setCodesStatus("Codes loaded.");
      } catch (e) {
        console.error("[getReceiveCodes] failed:", e);
        setCopyEnabled(false);
        setCodesStatus("Couldn’t load codes. Deploy functions/src/codes.ts and try again.");
      }
    }

    async function refreshRolling(){
      const user = auth.currentUser;
      if (!user) { setCodesStatus("Sign in first."); return; }

      try {
        setCodesStatus("Refreshing rolling…");
        const callable = functions.httpsCallable("refreshRollingReceiveCode");
        const res = await callable({});
        const data = res && res.data ? res.data : null;

        if (data && data.personal && data.secure && data.rolling) {
          renderCodes(data);
        } else if (data && data.code) {
          const patched = lastCodes ? JSON.parse(JSON.stringify(lastCodes)) : {};
          patched.rolling = patched.rolling || {};
          patched.rolling.code = data.code;
          if (data.expiresAtMillis) patched.rolling.expiresAtMillis = data.expiresAtMillis;
          renderCodes(patched);
        }

        setCodesStatus("Rolling refreshed.");
      } catch (e) {
        console.error("[refreshRollingReceiveCode] failed:", e);
        setCodesStatus("Couldn’t refresh rolling. Deploy functions/src/codes.ts and try again.");
      }
    }

    btnLoad.addEventListener("click", loadCodes);
    btnRefreshRolling.addEventListener("click", refreshRolling);

    setCopyEnabled(false);

    // ---------------------------
    // Delvee summary prefs section
    // ---------------------------
    const dvEnabled = document.getElementById("dv-enabled");
    const dvDest = document.getElementById("dv-dest");
    const dvWebBox = document.getElementById("dv-web-box");
    const dvWebType = document.getElementById("dv-web-type");
    const dvAppBox = document.getElementById("dv-app-box");
    const dvAppCode = document.getElementById("dv-app-code");

    const dvStatus = document.getElementById("dv-status");
    const dvSave = document.getElementById("dv-save");
    const dvReload = document.getElementById("dv-reload");

    function setDvStatus(t){ if (dvStatus) dvStatus.textContent = t || "Ready."; }

    function normalizeCodeLoose(raw) {
      return String(raw || "").trim().toUpperCase().replace(/[\s-]/g, "");
    }

    function applyDestUI() {
      const dest = dvDest.value;
      dvWebBox.classList.toggle("hidden", dest !== "setfeed_web_inbox");
      dvAppBox.classList.toggle("hidden", dest !== "setfeed_app_code");
    }

    dvDest.addEventListener("change", applyDestUI);

    async function loadDelveePrefs() {
      const user = auth.currentUser;
      if (!user) { setDvStatus("Sign in first."); return; }

      try {
        setDvStatus("Loading Delvee prefs…");
        const call = functions.httpsCallable("getDelveeSummaryPrefs");
        const res = await call({});
        const prefs = (res && res.data && res.data.prefs) ? res.data.prefs : null;

        dvEnabled.checked = !!(prefs && prefs.enabled);
        dvDest.value = (prefs && prefs.destination) ? prefs.destination : "setfeed_web_inbox";
        dvWebType.value = (prefs && prefs.setfeedWebCodeType) ? prefs.setfeedWebCodeType : "secure";
        dvAppCode.value = (prefs && prefs.setfeedAppReceiveCode) ? prefs.setfeedAppReceiveCode : "";

        applyDestUI();
        setDvStatus("Loaded.");
      } catch (e) {
        console.error("[getDelveeSummaryPrefs] failed:", e);
        setDvStatus("Couldn’t load Delvee prefs. Deploy updated delvee.ts and try again.");
      }
    }

    async function saveDelveePrefs() {
      const user = auth.currentUser;
      if (!user) { setDvStatus("Sign in first."); return; }

      try {
        setDvStatus("Saving…");
        dvSave.disabled = true;

        const enabled = !!dvEnabled.checked;
        const destination = dvDest.value;

        const payload = {
          enabled,
          destination,
          setfeedWebCodeType: dvWebType.value,
          setfeedAppReceiveCode: (destination === "setfeed_app_code") ? normalizeCodeLoose(dvAppCode.value) : null
        };

        const call = functions.httpsCallable("setDelveeSummaryPrefs");
        await call(payload);

        setDvStatus("Saved.");
      } catch (e) {
        console.error("[setDelveeSummaryPrefs] failed:", e);
        setDvStatus((e && e.message) ? e.message : "Couldn’t save. Try again.");
      } finally {
        dvSave.disabled = false;
      }
    }

    dvSave.addEventListener("click", saveDelveePrefs);
    dvReload.addEventListener("click", () => loadDelveePrefs());

    // Load once if already authed (fast path)
    if (auth.currentUser) loadDelveePrefs().catch(() => {});
  </script>
</body>
</html>
